<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>CryptoX Admin - å–å¼•ç®¡ç†</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <link rel="stylesheet" href="../assets/css/style.css">
  <link rel="stylesheet" href="../assets/css/admin.css">

  <style>
    /* ===== ãƒ¢ãƒ¼ãƒ€ãƒ« ===== */
    .modal-overlay {
      display: none;
      position: fixed;
      top: 0; left: 0;
      width: 100%; height: 100%;
      background: rgba(0,0,0,0.5);
      justify-content: center;
      align-items: center;
      z-index: 999;
    }
    .modal {
      background: #fff;
      border-radius: 8px;
      padding: 20px;
      width: 420px;
    }
    .modal-header {
      font-size: 18px;
      font-weight: bold;
      margin-bottom: 12px;
    }
    .modal-row { margin-bottom: 10px; }
    .modal-row label { font-size: 13px; display:block; margin-bottom:4px; }
    .modal-row input {
      width: 100%;
      padding: 7px 8px;
      border: 1px solid #ccc;
      border-radius: 6px;
    }
    .modal-actions { text-align: right; margin-top: 12px; }
  </style>
</head>

<body>

<!-- çœç•¥ï¼šã‚µã‚¤ãƒ‰ãƒãƒ¼ï¼ˆã‚ãªãŸã®æ—¢å­˜HTMLã¨åŒã˜ã§OKï¼‰ -->

<!-- SIDEBAR -->
<aside class="sidebar">
  <div class="sidebar-title">ãƒ¡ãƒ‹ãƒ¥ãƒ¼</div>
  <ul class="nav-list">
    <li class="nav-item"><a href="index.html" class="nav-link">ğŸ  ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰</a></li>
    <li class="nav-item"><a href="tickets.html" class="nav-link">ğŸ’¬ å•ã„åˆã‚ã›ç®¡ç†</a></li>
    <li class="nav-item"><a href="users.html" class="nav-link">ğŸ‘¥ ãƒ¦ãƒ¼ã‚¶ãƒ¼ä¸€è¦§</a></li>
    <li class="nav-item"><a href="trades.html" class="nav-link">ğŸ“Š å–å¼•çŠ¶æ³</a></li>
    <li class="nav-item"><a href="kyc.html" class="nav-link">ğŸ“‹ KYCçŠ¶æ³</a></li>
    <li class="nav-item"><a href="deposit.html" class="nav-link">â• å…¥é‡‘ç”³è«‹</a></li>
    <li class="nav-item"><a href="withdraw.html" class="nav-link">â– å‡ºé‡‘ç”³è«‹</a></li>
    <li class="nav-item"><a href="group.html" class="nav-link">ğŸ§© ã‚°ãƒ«ãƒ¼ãƒ—ç®¡ç†</a></li>
    <li class="nav-item"><a href="settings.html" class="nav-link">âš™ï¸ ã‚·ã‚¹ãƒ†ãƒ è¨­å®š</a></li>
    <li class="nav-item"><a href="system-positions.html" class="nav-link">ğŸ“ˆ ã‚·ã‚¹ãƒ†ãƒ ãƒã‚¸ã‚·ãƒ§ãƒ³</a></li>
    <li class="nav-item"><a href="system-history.html" class="nav-link active">ğŸ“œ ã‚·ã‚¹ãƒ†ãƒ å±¥æ­´</a></li>
  </ul>
</aside>

  <!-- ãƒ˜ãƒƒãƒ€ãƒ¼ -->
  <header class="admin-header">
    <div class="admin-header-left">
      <div class="admin-logo-badge">AX</div>
      <div>
        <div class="admin-logo-text">Admin Console</div>
        <div class="admin-logo-sub">ãƒ¦ãƒ¼ã‚¶ãƒ¼ä¸€è¦§</div>
      </div>
    </div>
    <div class="admin-header-right">
      <button class="btn btn-outline btn-sm" onclick="location.href='../login.html'">ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ</button>
    </div>
  </header>

<main class="admin-main">
<div class="admin-main-inner">

  <div class="page-title">å–å¼•ç®¡ç†</div>

  <!-- â–¼ ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ -->
  <section class="filters-card">
    <div class="filters-grid">

      <div class="field">
        <label>ã‚°ãƒ«ãƒ¼ãƒ—ID</label>
        <select id="f-group">
          <option value="">å…¨ã¦</option>
          <option value="1">1</option>
          <option value="2">2</option>
        </select>
      </div>

      <div class="field">
        <label>ãƒ¦ãƒ¼ã‚¶ãƒ¼ID</label>
        <input type="number" id="f-userId" />
      </div>

      <div class="field">
        <label>éŠ˜æŸ„</label>
        <select id="f-symbol">
          <option value="">å…¨ã¦</option>
          <option value="BTCUSDT">BTCUSDT</option>
          <option value="ETHUSDT">ETHUSDT</option>
        </select>
      </div>

      <div class="field">
        <label>å£²è²·</label>
        <select id="f-side">
          <option value="">å…¨ã¦</option>
          <option value="BUY">BUY</option>
          <option value="SELL">SELL</option>
        </select>
      </div>

      <div class="field">
        <label>æ±ºæ¸ˆæ—¥ FROM</label>
        <input type="date" id="f-from"/>
      </div>

      <div class="field">
        <label>æ±ºæ¸ˆæ—¥ TO</label>
        <input type="date" id="f-to"/>
      </div>

    </div>

    <div class="filter-actions">
      <button class="btn-xs" id="btn-clear">ã‚¯ãƒªã‚¢</button>
      <button class="btn-xs btn-primary" id="btn-search">æ¤œç´¢</button>
    </div>
  </section>

  <!-- â–¼ ãƒœã‚¿ãƒ³ï¼ˆCSV / ä¸€æ‹¬å‰Šé™¤ï¼‰ -->
  <div style="margin:10px 0; display:flex; gap:10px;">
    <button class="btn-xs" id="btn-refresh">å†èª­ã¿è¾¼ã¿</button>
    <button class="btn-xs btn-danger" id="btn-delete-selected">é¸æŠå‰Šé™¤</button>
    <button class="btn-xs btn-primary" id="btn-export">CSVã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ</button>
  </div>

  <!-- â–¼ ãƒ†ãƒ¼ãƒ–ãƒ« -->
  <section class="table-card">
    <div class="card-header-row">
      <div>
        <div class="card-title-small">å–å¼•ä¸€è¦§</div>
        <div class="card-sub-small" id="trade-count">0ä»¶</div>
      </div>
    </div>

    <table class="table">
      <thead>
        <tr>
          <th><input type="checkbox" id="check-all"></th>
          <th>ID</th>
          <th>ãƒ¦ãƒ¼ã‚¶ãƒ¼</th>
          <th>éŠ˜æŸ„</th>
          <th>å£²è²·</th>
          <th>æ•°é‡</th>
          <th>å»ºå€¤</th>
          <th>æ±ºæ¸ˆå€¤</th>
          <th>æç›Š</th>
          <th>æ±ºæ¸ˆæ—¥</th>
          <th>æ“ä½œ</th>
        </tr>
      </thead>
      <tbody id="trade-body"></tbody>
    </table>
  </section>

</div>
</main>

<!-- ===== ç·¨é›†ãƒ¢ãƒ¼ãƒ€ãƒ« ===== -->
<div class="modal-overlay" id="trade-modal">
  <div class="modal">
    <div class="modal-header">å–å¼•ç·¨é›†</div>

    <div class="modal-row">
      <label>æ•°é‡</label>
      <input id="m-size" />
    </div>

    <div class="modal-row">
      <label>å»ºå€¤</label>
      <input id="m-entry"/>
    </div>

    <div class="modal-row">
      <label>æ±ºæ¸ˆå€¤</label>
      <input id="m-close"/>
    </div>

    <div class="modal-row">
      <label>æç›Š</label>
      <input id="m-profit"/>
    </div>

    <div class="modal-row">
      <label>æ±ºæ¸ˆæ—¥æ™‚</label>
      <input id="m-closedAt" type="datetime-local"/>
    </div>

    <div class="modal-actions">
      <button id="modal-cancel">é–‰ã˜ã‚‹</button>
      <button class="btn-primary" id="modal-save">ä¿å­˜</button>
    </div>
  </div>
</div>

<script>
const API = "https://api.exchange-template.com";

let cacheTrades = [];
let editingId = null;

/* ------------------------------
  API å…±é€šé–¢æ•°
------------------------------ */
async function apiGet(path) {
  const r = await fetch(API + path, { credentials:"include" });
  const t = await r.text();
  if (!r.ok) throw new Error(t);
  return JSON.parse(t);
}
async function apiPost(path, body) {
  const r = await fetch(API + path, {
    method:"POST",
    credentials:"include",
    headers:{ "Content-Type":"application/json" },
    body: JSON.stringify(body)
  });
  const t = await r.text();
  if (!r.ok) throw new Error(t);
  return JSON.parse(t);
}

function fDate(v){ return new Date(v).toLocaleString("ja-JP",{hour12:false}); }

/* ------------------------------
  å–å¼•ä¸€è¦§ èª­ã¿è¾¼ã¿
------------------------------ */
async function loadTrades() {

  const q = [];
  const g = document.getElementById("f-group").value;
  const u = document.getElementById("f-userId").value;
  const s = document.getElementById("f-symbol").value;
  const side = document.getElementById("f-side").value;
  const from = document.getElementById("f-from").value;
  const to = document.getElementById("f-to").value;

  if(g) q.push(`group=${g}`);
  if(u) q.push(`userId=${u}`);
  if(s) q.push(`symbol=${s}`);
  if(side) q.push(`side=${side}`);
  if(from) q.push(`from=${from}`);
  if(to) q.push(`to=${to}`);

  const res = await apiGet("/admin/trades" + (q.length ? "?" + q.join("&") : ""));

  cacheTrades = res;

  const tbody = document.getElementById("trade-body");
  tbody.innerHTML = "";

  res.forEach(t => {
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td><input type="checkbox" class="row-check" data-id="${t.id}"></td>
      <td>${t.id}</td>
      <td>${t.user.email}</td>
      <td>${t.symbol}</td>
      <td>${t.side}</td>
      <td>${t.size}</td>
      <td>${t.entryPrice}</td>
      <td>${t.closePrice}</td>
      <td>${t.profit}</td>
      <td>${fDate(t.closedAt)}</td>
      <td>
        <button class="btn-xs" data-edit="${t.id}">ç·¨é›†</button>
        <button class="btn-xs btn-danger" data-del="${t.id}">å‰Šé™¤</button>
      </td>
    `;
    tbody.appendChild(tr);
  });

  document.getElementById("trade-count").textContent = res.length + "ä»¶";

  // ã‚¤ãƒ™ãƒ³ãƒˆä»˜ä¸
  document.querySelectorAll("[data-edit]").forEach(btn=>{
    btn.onclick = ()=> openModal(btn.dataset.edit);
  });
  document.querySelectorAll("[data-del]").forEach(btn=>{
    btn.onclick = ()=> deleteTrade(btn.dataset.del);
  });
}

/* ------------------------------
  ç·¨é›†ãƒ¢ãƒ¼ãƒ€ãƒ«
------------------------------ */
async function openModal(id){
  editingId = id;
  const t = await apiGet("/admin/trades?id=" + id);
  const trade = t[0];

  document.getElementById("m-size").value     = trade.size;
  document.getElementById("m-entry").value    = trade.entryPrice;
  document.getElementById("m-close").value    = trade.closePrice;
  document.getElementById("m-profit").value   = trade.profit;
  document.getElementById("m-closedAt").value = trade.closedAt.slice(0,16);

  document.getElementById("trade-modal").style.display = "flex";
}
document.getElementById("modal-cancel").onclick = () =>
  document.getElementById("trade-modal").style.display = "none";

document.getElementById("modal-save").onclick = async () => {
  await apiPost(`/admin/trades/${editingId}/edit`, {
    size:      document.getElementById("m-size").value,
    entryPrice:document.getElementById("m-entry").value,
    closePrice:document.getElementById("m-close").value,
    profit:    document.getElementById("m-profit").value,
    closedAt:  document.getElementById("m-closedAt").value,
  });

  document.getElementById("trade-modal").style.display = "none";
  loadTrades();
};

/* ------------------------------
  å‰Šé™¤
------------------------------ */
async function deleteTrade(id){
  if(!confirm("å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ")) return;
  await apiPost(`/admin/trades/${id}/delete`, {});
  loadTrades();
}

/* ------------------------------
  ä¸€æ‹¬å‰Šé™¤
------------------------------ */
document.getElementById("btn-delete-selected").onclick = async () => {
  const ids = [...document.querySelectorAll(".row-check:checked")]
              .map(cb => Number(cb.dataset.id));

  if(!ids.length){ alert("é¸æŠã•ã‚Œã¦ã„ã¾ã›ã‚“"); return; }

  if(!confirm(ids.length+"ä»¶å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ")) return;

  await apiPost("/admin/trades/bulk-delete", { ids });
  loadTrades();
};

/* ------------------------------
  CSV å‡ºåŠ›
------------------------------ */
document.getElementById("btn-export").onclick = ()=>{

  if(!cacheTrades.length){
    alert("ãƒ‡ãƒ¼ã‚¿ãªã—"); return;
  }

  let csv = "id,userId,email,symbol,side,size,entryPrice,closePrice,profit,openedAt,closedAt\n";
  cacheTrades.forEach(t=>{
    csv += `${t.id},${t.userId},${t.user.email},${t.symbol},${t.side},${t.size},${t.entryPrice},${t.closePrice},${t.profit},${t.openedAt},${t.closedAt}\n`;
  });

  const blob = new Blob([csv],{type:"text/csv"});
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url;
  a.download = "trades.csv";
  a.click();
  URL.revokeObjectURL(url);
};

/* ------------------------------
  å…¨é¸æŠ
------------------------------ */
document.getElementById("check-all").onclick = e=>{
  const on = e.target.checked;
  document.querySelectorAll(".row-check").forEach(cb=> cb.checked = on);
};

/* ------------------------------
  ã‚¤ãƒ™ãƒ³ãƒˆ
------------------------------ */
document.getElementById("btn-refresh").onclick = loadTrades;
document.getElementById("btn-search").onclick  = loadTrades;

document.getElementById("btn-clear").onclick = ()=>{
  ["f-group","f-userId","f-symbol","f-side","f-from","f-to"].forEach(id=>{
    document.getElementById(id).value = "";
  });
  loadTrades();
};

/* åˆæœŸãƒ­ãƒ¼ãƒ‰ */
loadTrades();

</script>

</body>
</html>
