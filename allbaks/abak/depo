<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>CryptoX Admin - å…¥é‡‘ç”³è«‹ç®¡ç†</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <link rel="stylesheet" href="../assets/css/style.css">
  <link rel="stylesheet" href="../assets/css/admin.css">
</head>
<body>

<!-- SIDEBAR -->
<aside class="sidebar">
  <div class="sidebar-title">ãƒ¡ãƒ‹ãƒ¥ãƒ¼</div>
  <ul class="nav-list">
    <li class="nav-item"><a href="index.html" class="nav-link">ğŸ  ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰</a></li>
    <li class="nav-item"><a href="tickets.html" class="nav-link">ğŸ’¬ å•ã„åˆã‚ã›ç®¡ç†</a></li>
    <li class="nav-item"><a href="users.html" class="nav-link">ğŸ‘¥ ãƒ¦ãƒ¼ã‚¶ãƒ¼ä¸€è¦§</a></li>
    <li class="nav-item"><a href="trades.html" class="nav-link">ğŸ“Š å–å¼•çŠ¶æ³</a></li>
    <li class="nav-item"><a href="kyc.html" class="nav-link">ğŸ“‹ KYCçŠ¶æ³</a></li>
    <li class="nav-item"><a href="deposit.html" class="nav-link">â• å…¥é‡‘ç”³è«‹</a></li>
    <li class="nav-item"><a href="withdraw.html" class="nav-link">â– å‡ºé‡‘ç”³è«‹</a></li>
    <li class="nav-item"><a href="group.html" class="nav-link">ğŸ§© ã‚°ãƒ«ãƒ¼ãƒ—ç®¡ç†</a></li>
    <li class="nav-item"><a href="settings.html" class="nav-link">âš™ï¸ ã‚·ã‚¹ãƒ†ãƒ è¨­å®š</a></li>
    <li class="nav-item"><a href="system-positions.html" class="nav-link">ğŸ“ˆ ã‚·ã‚¹ãƒ†ãƒ ãƒã‚¸ã‚·ãƒ§ãƒ³</a></li>
    <li class="nav-item"><a href="system-history.html" class="nav-link active">ğŸ“œ ã‚·ã‚¹ãƒ†ãƒ å±¥æ­´</a></li>
    <li class="nav-item"><a href="deposit-bank-accounts.html" class="nav-link">ğŸ“œ éŠ€è¡Œç®¡ç†</a></li>
  </ul>
</aside>

<header class="admin-header">
  <div class="admin-header-left">
    <div class="admin-logo-badge">AX</div>
    <div>
      <div class="admin-logo-text">Admin Console</div>
      <div class="admin-logo-sub">å…¥é‡‘ç”³è«‹ç®¡ç†</div>
    </div>
  </div>
</header>

<main class="admin-main">
  <div class="admin-main-inner">

    <div class="page-title">å…¥é‡‘ç”³è«‹ä¸€è¦§</div>

    <!-- ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ -->
    <div style="margin:12px 0;">
      <select id="status-filter" class="btn-sm">
        <option value="ALL">ã™ã¹ã¦</option>
        <option value="PENDING">ç”³è«‹ä¸­</option>
        <option value="COMPLETED">å®Œäº†</option>
        <option value="CANCELED">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</option>
      </select>
      <button class="btn-sm" id="reload-btn">å†èª­ã¿è¾¼ã¿</button>
    </div>

    <!-- TABLE -->
    <div class="card" style="margin-top:16px;">
      <table class="table" style="width:100%; font-size:13px;">
        <thead>
          <tr>
            <th>ID</th>
            <th>ç”³è«‹æ—¥æ™‚</th>
            <th>åå‰</th>
            <th>ç¨®åˆ¥</th>
            <th>é€šè²¨</th>
            <th>ç”³è«‹é‡‘é¡</th>
            <th>å…¥é‡‘é¡</th>
            <th>æ›´æ–°æ—¥æ™‚</th>
            <th>ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹</th>
            <th>æ“ä½œ</th>
          </tr>
        </thead>
        <tbody id="deposit-table-body">
          <tr><td colspan="10" style="text-align:center;color:#777;">èª­ã¿è¾¼ã¿ä¸­...</td></tr>
        </tbody>
      </table>
    </div>

  </div>
</main>

<div class="toast" id="toast"></div>

<script>
const API_BASE = "https://api.exchange-template.com";

/* =========================
   Toast
========================= */
function showToast(msg) {
  const t = document.getElementById("toast");
  t.textContent = msg;
  t.classList.add("show");
  setTimeout(() => t.classList.remove("show"), 2000);
}

/* =========================
   Formatters
========================= */
function formatDate(v) {
  return v ? new Date(v).toLocaleString("ja-JP", { hour12:false }) : "-";
}

/**
 * é‡‘é¡ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ
 * type = "JPY" | "CRYPTO"
 */
function formatAmount(value, type = "JPY") {
  const num = Number(value);
  if (isNaN(num)) return "-";

  if (type === "CRYPTO") {
    // æš—å·è³‡ç”£ï¼šå°æ•°ç‚¹ä»¥ä¸‹4æ¡
    return num.toFixed(4);
  }

  // æ—¥æœ¬å††ï¼šã‚«ãƒ³ãƒåŒºåˆ‡ã‚Šãƒ»å°æ•°ãªã—
  return Math.floor(num).toLocaleString("ja-JP");
}

/* =========================
   API wrappers
========================= */
async function apiGet(path) {
  const res = await fetch(API_BASE + path, { credentials:"include" });
  if (!res.ok) throw new Error();
  return res.json();
}

async function apiPost(path, body) {
  const res = await fetch(API_BASE + path, {
    method:"POST",
    credentials:"include",
    headers:{ "Content-Type":"application/json" },
    body: JSON.stringify(body),
  });
  if (!res.ok) throw new Error();
}

/* =========================
   Actions
========================= */
async function approveDeposit(id) {
  try {
    await apiPost("/deposit/approve", { id });
    showToast("æ‰¿èªã—ã¾ã—ãŸ");
    loadDeposits();
  } catch {
    showToast("æ‰¿èªã«å¤±æ•—ã—ã¾ã—ãŸ");
  }
}

function openChat(userId) {
  if (!userId) {
    showToast("ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ãŒã‚ã‚Šã¾ã›ã‚“");
    return;
  }
  location.href = `tickets.html?user=${userId}`;
}

/* =========================
   Render table
========================= */
function renderTable(list) {
  const tbody = document.getElementById("deposit-table-body");
  tbody.innerHTML = "";

  if (!list.length) {
    tbody.innerHTML =
      '<tr><td colspan="10" style="text-align:center;">ç”³è«‹ãªã—</td></tr>';
    return;
  }

  list.forEach(t => {
    // CRYPTO åˆ¤å®šï¼ˆæœ€ã‚‚å®‰å…¨ï¼‰
    const isCrypto =
      t.cryptoAmount !== null &&
      !isNaN(Number(t.cryptoAmount)) &&
      Number(t.cryptoAmount) > 0;

    const methodLabel = isCrypto ? "æš—å·è³‡ç”£" : "æ—¥æœ¬å††";
    const currency = isCrypto ? t.currency : "JPY";

    // ç”³è«‹é‡‘é¡ï¼ˆå¸¸ã«JPYï¼‰
    const requestAmount =
      `${formatAmount(t.amount, "JPY")} JPY`;

    // å…¥é‡‘é¡ï¼ˆJPY or CRYPTOï¼‰
    const depositAmount = isCrypto
      ? `${formatAmount(t.cryptoAmount, "CRYPTO")} ${currency}`
      : `${formatAmount(t.amount, "JPY")} JPY`;

    const statusJP =
      t.status === "PENDING" ? "ç”³è«‹ä¸­" :
      t.status === "COMPLETED" ? "å®Œäº†" :
      "ã‚­ãƒ£ãƒ³ã‚»ãƒ«";

    tbody.insertAdjacentHTML("beforeend", `
      <tr>
        <td>${t.id}</td>
        <td>${formatDate(t.createdAt)}</td>
        <td>${t.user?.name ?? "-"}</td>
        <td>${methodLabel}</td>
        <td>${currency}</td>
        <td>${requestAmount}</td>
        <td>${depositAmount}</td>
        <td>${formatDate(t.updatedAt)}</td>
        <td>${statusJP}</td>
        <td>
          ${
            t.status === "PENDING"
              ? `<button class="btn-xs btn-xs-primary"
                         onclick="approveDeposit(${t.id})">æ‰¿èª</button>`
              : ""
          }
          <button class="btn-xs btn-warning"
                  onclick="openChat(${t.user?.id})">ãƒãƒ£ãƒƒãƒˆ</button>
        </td>
      </tr>
    `);
  });
}

/* =========================
   Load + Filter
========================= */
async function loadDeposits() {
  try {
    const status = document.getElementById("status-filter").value;

    let list = await apiGet("/deposit/all");

    // é˜²å¾¡ãƒ­ã‚¸ãƒƒã‚¯
    if (status === "PENDING") {
      list = await apiGet("/deposit/pending");
    } else if (status !== "ALL") {
      list = list.filter(
        t => String(t.status).toUpperCase() === status
      );
    }

    renderTable(list);
  } catch {
    showToast("å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ");
  }
}

/* =========================
   Init
========================= */
document.getElementById("status-filter").addEventListener("change", loadDeposits);
document.getElementById("reload-btn").addEventListener("click", loadDeposits);
loadDeposits();
</script>


</body>
</html>
