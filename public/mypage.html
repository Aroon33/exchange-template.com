<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>CryptoX Exchange - マイページ</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link rel="stylesheet" href="assets/css/style.css">

  <style>
    /* -----------------------------
          カード（統一UI）
    ------------------------------*/
    .section-card {
      background: #fff;
      margin: 20px auto;
      padding: 20px;
      border-radius: 12px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.06);
      max-width: 760px;
    }

    h1.card-title {
      font-size: 22px;
      margin-bottom: 10px;
    }

    h2.section-title {
      font-size: 18px;
      font-weight: bold;
      margin: 18px 0 10px;
    }

    /* -----------------------------
          情報表示（info-grid）
    ------------------------------*/
    .info-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
    }
    @media (max-width:600px) {
      .info-grid {
        grid-template-columns: 1fr;
      }
    }

    .info-box {
      background: #f8fafc;
      border: 1px solid #e5e7eb;
      padding: 12px;
      border-radius: 10px;
    }
    .info-label {
      font-size: 12px;
      color: #6b7280;
    }
    .info-value {
      font-size: 17px;
      margin-top: 4px;
      font-weight: bold;
    }

    /* -----------------------------
          KYC バッジ
    ------------------------------*/
    .kyc-pill {
      padding: 6px 12px;
      font-size: 13px;
      border-radius: 20px;
      display: inline-block;
      font-weight: bold;
    }
    .kyc-0 { background:#fee2e2; color:#b91c1c; }
    .kyc-1 { background:#fef3c7; color:#92400e; }
    .kyc-2 { background:#fef9c3; color:#854d0e; }
    .kyc-3 { background:#d9f99d; color:#365314; }
    .kyc-4 { background:#bbf7d0; color:#166534; }
    .kyc-5 { background:#86efac; color:#065f46; }

    /* -----------------------------
          残高ボックス
    ------------------------------*/
    .balance-boxes {
      display: flex;
      flex-wrap: wrap;
      gap: 12px;
      margin-top: 10px;
    }
    .balance-item {
      flex: 1;
      min-width: 120px;
      padding: 12px;
      border-radius: 10px;
      background: #eef2ff;
      border: 1px solid #e5e7eb;
    }
    .balance-value {
      font-size: 20px;
      font-weight: bold;
      margin-top: 6px;
    }
    .input-text {
  width: 100%;
  margin-top: 6px;
  padding: 10px;
  border-radius: 8px;
  border: 1px solid var(--border-soft);
  background: #fff;
  font-size: 14px;
}
.input-text:focus {
  outline: 2px solid var(--primary-light);
}

  </style>
</head>

<body>

<!-- HEADER -->
<header class="site-header">
  <div class="logo">
    <div class="logo-badge">CX</div>
    CryptoX Exchange
  </div>

  <nav class="site-nav">
    <a href="index.html" class="nav-link">TOP</a>
    <a href="exchange.html" class="nav-link">トレード</a>
    <a href="wallet.html" class="nav-link">ウォレット</a>
    <a href="system-trade.html" class="nav-link">システム取引</a>
    <a href="support.html" class="nav-link">サポート</a>
    <a href="mypage.html" class="nav-link active">マイページ</a>
    <a href="kyc.html" class="nav-link">KYC</a>
    <a href="history.html" class="nav-link">取引履歴</a>
  </nav>

  <div class="header-actions">
    <a href="login.html" class="btn btn-outline btn-sm">ログイン</a>
    <a href="signup.html" class="btn btn-primary btn-sm">口座開設</a>
  </div>
</header>

<!-- MAIN -->
<main>
  <section class="section-card">
    <h1 class="card-title">マイページ</h1>
    <p id="mypage-message" class="muted"></p>

    <!-- ----------------------------
          アカウント情報
    ----------------------------- -->
    <h2 class="section-title">アカウント情報</h2>
    <div class="info-grid">
      <div class="info-box">
        <div class="info-label">メールアドレス</div>
        <div class="info-value" id="my-email">-</div>
      </div>

      <div class="info-box">
        <div class="info-label">名前</div>
        <div class="info-value" id="my-name">-</div>
      </div>

      <div class="info-box">
        <div class="info-label">グループID</div>
        <div class="info-value" id="my-group">-</div>
      </div>
    </div>

    <!-- ----------------------------
          KYC ステータス（繰り上げ）
    ----------------------------- -->
    <h2 class="section-title">KYC ステータス</h2>
    <div class="info-grid">
      <div class="info-box">
        <div class="info-label">あなたの KYC レベル</div>
        <div class="info-value">
          <span id="my-kyc-pill" class="kyc-pill kyc-0">-</span>
        </div>
      </div>
    </div>

    <!-- ----------------------------
          残高サマリー
    ----------------------------- -->
    <h2 class="section-title">残高サマリー</h2>
    <div class="balance-boxes">
      <div class="balance-item">
        <div class="info-label">総残高</div>
        <div class="balance-value" id="my-balance-total">0</div>
      </div>

      <div class="balance-item">
        <div class="info-label">利用可能残高</div>
        <div class="balance-value" id="my-balance-available">0</div>
      </div>

      <div class="balance-item">
        <div class="info-label">ロック残高</div>
        <div class="balance-value" id="my-balance-locked">0</div>
      </div>
    </div>

  </section>
  <!-- =============================
      銀行口座の登録（出金用）
============================= -->
<section class="section-card" style="max-width:760px;">
  <h2 class="section-title">銀行口座の登録（出金用）</h2>
  <p id="bank-msg" class="muted"></p>

  <div class="info-grid">

    <div class="info-box">
      <div class="info-label">銀行名</div>
      <input id="bank-name" class="input-text" placeholder="例：みずほ銀行">
    </div>

    <div class="info-box">
      <div class="info-label">支店名</div>
      <input id="bank-branch" class="input-text" placeholder="例：渋谷支店">
    </div>

    <div class="info-box">
      <div class="info-label">口座種別</div>
      <select id="bank-type" class="input-text">
        <option value="普通">普通</option>
        <option value="当座">当座</option>
      </select>
    </div>

    <div class="info-box">
      <div class="info-label">口座番号</div>
      <input id="bank-number" class="input-text" placeholder="例：1234567">
    </div>

    <div class="info-box" style="grid-column: 1 / -1;">
      <div class="info-label">口座名義（全角カナ）</div>
      <input id="bank-holder" class="input-text" placeholder="例：ヤマダ タロウ">
    </div>

  </div>

  <button id="save-bank" class="btn btn-primary" style="margin-top:14px;">
    保存する
  </button>
</section>
<!-- =============================
      暗号通貨アドレスの登録
============================= -->
<section class="section-card" style="max-width:760px;">
  <h2 class="section-title">暗号通貨アドレスの登録</h2>
  <p id="crypto-msg" class="muted"></p>

  <div class="info-grid">

    <div class="info-box">
      <div class="info-label">BTC アドレス</div>
      <input id="crypto-btc" class="input-text" placeholder="例：bc1xxxx...">
    </div>

    <div class="info-box">
      <div class="info-label">ETH アドレス</div>
      <input id="crypto-eth" class="input-text" placeholder="例：0xABC123...">
    </div>

    <div class="info-box" style="grid-column: 1 / -1;">
      <div class="info-label">USDT（TRC20）</div>
      <input id="crypto-usdt" class="input-text" placeholder="例：TXYZ1234...">
    </div>

  </div>

  <button id="save-crypto" class="btn btn-primary" style="margin-top:14px;">
    保存する
  </button>
</section>




</main>


<!-- =============================
      API Script
================================= -->
<script>
const API_BASE_URL = "https://api.exchange-template.com";

const elMsg   = document.getElementById("mypage-message");

const elEmail = document.getElementById("my-email");
const elName  = document.getElementById("my-name");
const elGroup = document.getElementById("my-group");
const elSys   = document.getElementById("my-system-status");

const elKycPill = document.getElementById("my-kyc-pill");

const elBalTotal = document.getElementById("my-balance-total");
const elBalAvail = document.getElementById("my-balance-available");
const elBalLock  = document.getElementById("my-balance-locked");

async function apiGet(path) {
  const res = await fetch(API_BASE_URL + path, { credentials:"include" });
  if (!res.ok) throw new Error(await res.text());
  return res.json();
}

function fmtAmount(n){
  if(!n) return "0";
  return Number(n).toLocaleString("en-US", { minimumFractionDigits: 2 });
}

/* ----------------------------
      Load Me
----------------------------- */
async function loadMe() {
  const data = await apiGet("/auth/me");
  const u = data.user || data;

  elEmail.textContent = u.email ?? "-";
  elName.textContent  = u.name  ?? "-";
  elGroup.textContent = u.groupId ?? "-";
 }

/* ----------------------------
      KYC
----------------------------- */
async function loadKyc() {
  try {
    const k = await apiGet("/kyc/status");
    const lv = Number(k.level ?? 0);

    elKycPill.textContent = `レベル ${lv}`;
    elKycPill.className = `kyc-pill kyc-${lv}`;
  } catch {
    elKycPill.textContent = "取得エラー";
  }
}

/* ----------------------------
      Wallet
----------------------------- */
async function loadWallet() {
  const d = await apiGet("/wallet");
  const w = d.wallet || {};

  elBalTotal.textContent = fmtAmount(w.balanceTotal ?? 0);
  elBalAvail.textContent = fmtAmount(w.balanceAvailable ?? 0);
  elBalLock.textContent  = fmtAmount(w.balanceLocked ?? 0);
}
async function loadBankInfo() {
  try {
    const res = await fetch(API_BASE_URL + "/user/bank-account", {
      credentials: "include",
    });
    if (!res.ok) return; // 未設定なら無視

    const bank = await res.json();

    document.getElementById("bank-name").value   = bank.bankName || "";
    document.getElementById("bank-branch").value = bank.branchName || "";
    document.getElementById("bank-type").value   = bank.accountType || "普通";
    document.getElementById("bank-number").value = bank.accountNumber || "";
    document.getElementById("bank-holder").value = bank.accountHolder || "";

  } catch (e) {
    console.warn("銀行口座情報の取得に失敗:", e);
  }
}

/* ----------------------------
      Init
----------------------------- */
(async function init(){
  try {
    await loadMe();
    await loadKyc();
    await loadWallet();
    await loadBankInfo();

    elMsg.textContent = "最新情報を取得しました。";
    elMsg.style.color = "green";
  } catch (e) {
    console.error(e);
    elMsg.textContent = "情報取得に失敗しました。ログイン状態を確認してください。";
    elMsg.style.color = "red";
  }
})();

const API_BASE = "https://api.exchange-template.com";

async function updateHeaderUserState() {
  const loginBtn = document.querySelector(".header-actions a[href='login.html']");
  const signupBtn = document.querySelector(".header-actions a[href='signup.html']");

  if (!loginBtn || !signupBtn) return;

  try {
    const res = await fetch(API_BASE + "/auth/me", { credentials: "include" });
    if (!res.ok) return; // 未ログインなら何もしない

    const data = await res.json();
    const user = data.user || data;

    // 既存ボタンをクリア
    const headerActions = document.querySelector(".header-actions");
    headerActions.innerHTML = "";

    // マイページボタン
    const mp = document.createElement("a");
    mp.href = "mypage.html";
    mp.className = "btn btn-outline btn-sm";
    mp.textContent = user.name + " さん";
    headerActions.appendChild(mp);

    // ログアウトボタン
    const lo = document.createElement("a");
    lo.href = "#";
    lo.className = "btn btn-primary btn-sm";
    lo.textContent = "ログアウト";
    lo.addEventListener("click", async () => {
      await fetch(API_BASE + "/auth/logout", {
        method: "POST",
        credentials: "include"
      });
      location.href = "login.html";
    });
    headerActions.appendChild(lo);

  } catch (e) {
    console.warn("Not logged in");
  }
}
document.getElementById("save-bank").onclick = async () => {
  const body = {
    bankName: document.getElementById("bank-name").value,
    branchName: document.getElementById("bank-branch").value,
    accountType: document.getElementById("bank-type").value,
    accountNumber: document.getElementById("bank-number").value,
    accountHolder: document.getElementById("bank-holder").value,
  };

  try {
    const res = await fetch(API_BASE_URL + "/user/bank-account", {
  method: "POST",
  credentials: "include",
  headers: { "Content-Type": "application/json" },
  body: JSON.stringify(body),
});


    if (!res.ok) throw new Error(await res.text());

    document.getElementById("bank-msg").textContent = "銀行情報を保存しました";
    document.getElementById("bank-msg").style.color = "green";

  } catch (err) {
    document.getElementById("bank-msg").textContent = "保存に失敗しました";
    document.getElementById("bank-msg").style.color = "red";
  }
};
document.getElementById("save-crypto").onclick = async () => {
  const addresses = [
    { currency: "BTC",  address: document.getElementById("crypto-btc").value },
    { currency: "ETH",  address: document.getElementById("crypto-eth").value },
    { currency: "USDT", address: document.getElementById("crypto-usdt").value },
  ];

  try {
    const res = await fetch(API_BASE_URL + "/user/crypto-address", {   // ★ 修正
      method: "POST",
      credentials: "include",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ addresses }),   // 送信形式はそのままでOK
    });

    if (!res.ok) throw new Error(await res.text());

    const msg = document.getElementById("crypto-msg");
    msg.textContent = "アドレスを保存しました";
    msg.style.color = "green";

  } catch (err) {
    const msg = document.getElementById("crypto-msg");
    msg.textContent = "保存に失敗しました";
    msg.style.color = "red";
  }
};


// ページ読込後に実行
document.addEventListener("DOMContentLoaded", updateHeaderUserState);
</script>

</body>
</html>
