<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8" />
<title>CryptoX Exchange - お問い合わせ</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<link rel="stylesheet" href="assets/css/style.css">

<style>
/* ============================= レイアウト ============================= */
.support-container {
  max-width: 1120px;
  margin: 0 auto;
  padding: 20px;
  display: grid;
  grid-template-columns: 0.9fr 1.4fr;
  gap: 16px;
}
@media (max-width:820px) {
  .support-container { grid-template-columns: 1fr; }
}
.section-card {
  background:#fff;
  padding:18px;
  border-radius:12px;
  box-shadow:0 2px 6px rgba(0,0,0,0.06);
}
.section-title {
  font-size:18px;
  font-weight:bold;
  margin-bottom:10px;
}

/* ============================= フォーム ============================= */
textarea {
  width:100%;
  min-height:80px;
  border-radius:8px;
  border:1px solid #d1d5db;
  padding:10px;
  font-size:14px;
}
.form-row { margin-bottom:14px; }
.form-row label {
  font-size:13px;
  margin-bottom:4px;
  display:block;
}

/* ============================= スレッド一覧 ============================= */
.thread-list { margin-top:12px; border-top:1px solid #e5e7eb; }
.thread-row {
  padding:12px 6px;
  cursor:pointer;
  border-bottom:1px solid #eee;
}
.thread-row:hover { background:#f9fafb; }
.thread-title { font-size:14px; font-weight:bold; }
.thread-meta { font-size:11px; color:#777; }

/* ============================= チャット ============================= */
.chat-header {
  display:flex;
  justify-content:space-between;
  align-items:center;
  padding-bottom:12px;
  border-bottom:1px solid #e5e7eb;
  margin-bottom:10px;
}
.chat-thread-title { font-size:17px; font-weight:bold; }
.chat-window {
  max-height:440px;
  overflow-y:auto;
  padding:10px 4px;
  background:#f8fafc;
  border-radius:8px;
  border:1px solid #e5e7eb;
}
.chat-msg {
  margin-bottom:14px;
  padding:10px 12px;
  border-radius:10px;
  max-width:85%;
}
.chat-msg.user { background:#e0f2fe; margin-left:auto; }
.chat-msg.admin { background:#ede9fe; margin-right:auto; }
.chat-meta { font-size:11px; margin-bottom:4px; color:#555; }
#chat-input-area {
  margin-top:12px;
  display:none;
  gap:10px;
}
#chat-input {
  flex:1;
  min-height:60px;
  padding:10px;
  border-radius:8px;
  border:1px solid #d1d5db;
}

/* ============================= モバイルメニュー ============================= */
.hamburger { display:none; font-size:28px; background:none; border:none; }
@media(max-width:768px){
  .hamburger { display:block; }
  .site-nav { display:none; }
}
.mobile-menu {
  position:fixed;
  top:0;
  left:-260px;
  width:240px;
  height:100%;
  background:#fff;
  padding:20px;
  z-index:9999;
  transition:0.3s;
}
.mobile-menu.open { left:0; }
.menu-overlay {
  display:none;
  position:fixed;
  top:0; left:0;
  width:100%; height:100%;
  background:rgba(0,0,0,0.4);
  z-index:9998;
}
.menu-overlay.show { display:block; }
</style>
</head>

<body>

<!-- ============================= ヘッダー ============================= -->
<header class="site-header">
  <div class="logo">
    <div class="logo-badge">CX</div> CryptoX Exchange
  </div>

  <button id="menu-toggle" class="hamburger">☰</button>


  <nav class="site-nav">
    <a href="index.html" class="nav-link">TOP</a>
    <a href="exchange.html" class="nav-link">トレード</a>
    <a href="wallet.html" class="nav-link">ウォレット</a>
    <a href="system-trade.html" class="nav-link active">システム取引</a>
    <a href="support.html" class="nav-link">サポート</a>
    <a href="mypage.html" class="nav-link">マイページ</a>
    <a href="kyc.html" class="nav-link">KYC</a>
    <a href="history.html" class="nav-link">取引履歴</a>
  </nav>


  <div class="header-actions">
    <a href="login.html" class="btn btn-outline btn-sm">ログイン</a>
    <a href="signup.html" class="btn btn-primary btn-sm">口座開設</a>
  </div>

</header>

<!-- モバイルメニュー -->
<div id="mobile-menu" class="mobile-menu">
  <button id="menu-close" class="close-btn">×</button>


  <a href="index.html">TOP</a>
  <a href="exchange.html">トレード</a>
  <a href="wallet.html">ウォレット</a>
  <a href="system-trade.html">システム取引</a>
  <a href="support.html">サポート</a>
  <a href="mypage.html">マイページ</a>
  <a href="kyc.html">KYC</a>
  <a href="history.html">取引履歴</a>
  <a href="logout.html">ログアウト</a>
</div>
<div id="menu-overlay" class="menu-overlay"></div>

<!-- ============================= MAIN ============================= -->
<main class="support-container">

<section class="section-card">
  <h2 class="section-title">お問い合わせを送信</h2>
  <div class="form-row">
    <label>件名</label>
    <input type="text" id="new-title">
  </div>
  <div class="form-row">
    <label>内容</label>
    <textarea id="new-body"></textarea>
  </div>
  <button id="btn-create-thread">問い合わせを送信</button>

  <hr>
  <h3 class="section-title" style="font-size:15px;">
    あなたの問い合わせ一覧 <span id="thread-count"></span>
  </h3>
  <div id="thread-list" class="thread-list"></div>
</section>

<section class="section-card">
  <div class="chat-header">
    <div>
      <div id="chat-title" class="chat-thread-title">問い合わせを選択してください</div>
      <div id="chat-sub" style="font-size:12px;color:#777;">左からスレッドを選択</div>
    </div>
    
  </div>

  <div id="chat-window" class="chat-window">
    <div style="text-align:center;color:#888;padding:16px;">
      スレッドを選択するとメッセージが表示されます。
    </div>
  </div>
  
  <div id="chat-input-area">
    <textarea id="chat-input"></textarea>
    <button id="btn-send-msg">送信</button>
  </div>
</section>

</main>

<script>
const API_BASE_URL = "https://api.exchange-template.com";

/* ---------------- API ---------------- */
async function apiGet(path){
  const r = await fetch(API_BASE_URL + path,{credentials:"include"});
  return r.json();
}
async function apiPost(path,body){
  const r = await fetch(API_BASE_URL + path,{
    method:"POST",
    credentials:"include",
    headers:{ "Content-Type":"application/json" },
    body:JSON.stringify(body)
  });
  return r.json();
}

/* ---------------- Ticket ---------------- */
const newTitleEl=document.getElementById("new-title");
const newBodyEl=document.getElementById("new-body");
const threadListEl=document.getElementById("thread-list");
const threadCountEl=document.getElementById("thread-count");
let currentTicketId=null;

async function loadTickets(){
  const tickets=await apiGet("/tickets");
  threadListEl.innerHTML="";
  threadCountEl.textContent=`${tickets.length}件`;

  tickets.forEach(t=>{
    const row=document.createElement("div");
    row.className="thread-row";
    row.innerHTML=`
      <div class="thread-title">${t.title}</div>
      <div class="thread-meta">
        ID:${t.id} ／ ${new Date(t.createdAt).toLocaleString("ja-JP")}
      </div>`;
    row.onclick=()=>{
      currentTicketId=t.id;
      loadMessages();
    };
    threadListEl.appendChild(row);
  });
}

async function loadMessages(){
  const msgs=await apiGet(`/tickets/${currentTicketId}/messages`);
  const chatWindow=document.getElementById("chat-window");
  chatWindow.innerHTML="";
  msgs.forEach(m=>{
    const div=document.createElement("div");
    div.className="chat-msg "+(m.sender==="ADMIN"?"admin":"user");
    div.innerHTML=`
      <div class="chat-meta">
        ${m.sender} ／ ${new Date(m.createdAt).toLocaleString("ja-JP")}
      </div>
      <div>${m.message}</div>`;
    chatWindow.appendChild(div);
  });
  document.getElementById("chat-title").textContent=`スレッド #${currentTicketId}`;
  document.getElementById("chat-input-area").style.display="flex";
}

document.getElementById("btn-create-thread").onclick=async()=>{
  if(!newTitleEl.value||!newBodyEl.value)return;
  await apiPost("/tickets",{title:newTitleEl.value,message:newBodyEl.value});
  newTitleEl.value="";
  newBodyEl.value="";
  loadTickets();
};

document.getElementById("btn-send-msg").onclick=async()=>{
  const msg=document.getElementById("chat-input").value;
  if(!msg)return;
  await apiPost(`/tickets/${currentTicketId}/reply`,{message:msg});
  document.getElementById("chat-input").value="";
  loadMessages();
};

/* ---------------- Menu ---------------- */
const toggle=document.getElementById("menu-toggle");
const menu=document.getElementById("mobile-menu");
const overlay=document.getElementById("menu-overlay");
toggle.onclick=()=>{menu.classList.add("open");overlay.classList.add("show");};
overlay.onclick=()=>{menu.classList.remove("open");overlay.classList.remove("show");};

loadTickets();

/* =========================
   ヘッダー：ログイン状態反映
========================= */
async function updateHeaderUserState() {
  const headerActions = document.querySelector(".header-actions");
  if (!headerActions) return;

  try {
    const res = await fetch(API_BASE_URL + "/auth/me", {
      credentials: "include",
    });
    if (!res.ok) return; // 未ログイン

    const data = await res.json();
    const user = data.user || data;

    // ヘッダー右側を差し替え
    headerActions.innerHTML = "";

    const userBtn = document.createElement("a");
    userBtn.href = "users.html";
    userBtn.className = "btn btn-outline btn-sm";
    userBtn.textContent = user.name + " さん";
    headerActions.appendChild(userBtn);

    const logoutBtn = document.createElement("a");
    logoutBtn.href = "#";
    logoutBtn.className = "btn btn-primary btn-sm";
    logoutBtn.textContent = "ログアウト";
    logoutBtn.onclick = async () => {
      await fetch(API_BASE_URL + "/auth/logout", {
        method: "POST",
        credentials: "include",
      });
      location.href = "../login.html";
    };
    headerActions.appendChild(logoutBtn);

  } catch (e) {
    console.warn("ログイン状態取得失敗", e);
  }
}

/* 初期化 */
document.addEventListener("DOMContentLoaded", updateHeaderUserState);
</script>


</body>
</html>
