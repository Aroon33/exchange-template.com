<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>CryptoX Admin - ã‚·ã‚¹ãƒ†ãƒ å–å¼•å±¥æ­´</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <link rel="stylesheet" href="../assets/css/style.css">
  <link rel="stylesheet" href="../assets/css/admin.css">
</head>

<body>

<!-- SIDEBAR -->
<aside class="sidebar">
  <div class="sidebar-title">ãƒ¡ãƒ‹ãƒ¥ãƒ¼</div>
  <ul class="nav-list">
    <li class="nav-item"><a href="index.html" class="nav-link">ğŸ  ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰</a></li>
    <li class="nav-item"><a href="tickets.html" class="nav-link">ğŸ’¬ å•ã„åˆã‚ã›ç®¡ç†</a></li>
    <li class="nav-item"><a href="users.html" class="nav-link">ğŸ‘¥ ãƒ¦ãƒ¼ã‚¶ãƒ¼ä¸€è¦§</a></li>
    <li class="nav-item"><a href="trades.html" class="nav-link">ğŸ“Š å–å¼•çŠ¶æ³</a></li>
    <li class="nav-item"><a href="kyc.html" class="nav-link">ğŸ“‹ KYCçŠ¶æ³</a></li>
    <li class="nav-item"><a href="deposit.html" class="nav-link">â• å…¥é‡‘ç”³è«‹</a></li>
    <li class="nav-item"><a href="withdraw.html" class="nav-link">â– å‡ºé‡‘ç”³è«‹</a></li>
    <li class="nav-item"><a href="group.html" class="nav-link">ğŸ§© ã‚°ãƒ«ãƒ¼ãƒ—ç®¡ç†</a></li>
    <li class="nav-item"><a href="settings.html" class="nav-link">âš™ï¸ ã‚·ã‚¹ãƒ†ãƒ è¨­å®š</a></li>
    <li class="nav-item"><a href="system-positions.html" class="nav-link">ğŸ“ˆ ã‚·ã‚¹ãƒ†ãƒ ãƒã‚¸ã‚·ãƒ§ãƒ³</a></li>
    <li class="nav-item"><a href="system-history.html" class="nav-link active">ğŸ“œ ã‚·ã‚¹ãƒ†ãƒ å±¥æ­´</a></li>
  </ul>
</aside>

<!-- HEADER -->
<header class="admin-header">
  <div class="admin-header-left">
    <div class="admin-logo-badge">AX</div>
    <div>
      <div class="admin-logo-text">Admin Console</div>
      <div class="admin-logo-sub">ã‚·ã‚¹ãƒ†ãƒ å–å¼•å±¥æ­´</div>
    </div>
  </div>
  <div class="admin-header-right">
    <button class="btn btn-outline btn-sm" onclick="location.href='../login.html'">ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ</button>
  </div>
</header>

<!-- MAIN -->
<main class="admin-main">
  <div class="admin-main-inner">

    <div class="page-title">ã‚°ãƒ«ãƒ¼ãƒ—å–å¼•å±¥æ­´</div>

    <!-- ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ -->
    <section class="filters-card">

      <div class="filters-grid">

        <div class="field">
          <label>ã‚°ãƒ«ãƒ¼ãƒ—ID</label>
          <select id="groupSelect">
            <option value="">é¸æŠã—ã¦ãã ã•ã„</option>
          </select>
        </div>

        <div class="field">
          <label>éŠ˜æŸ„ï¼ˆSymbolï¼‰</label>
          <input type="text" id="fSymbol" placeholder="ä¾‹ï¼šBTCUSDT" />
        </div>

        <div class="field">
          <label>ãƒ¦ãƒ¼ã‚¶ãƒ¼IDï¼ˆä»»æ„ï¼‰</label>
          <input type="number" id="fUserId" placeholder="ä¾‹ï¼š8" />
        </div>

        <div class="field">
          <label>çŠ¶æ…‹</label>
          <select id="fStatus">
            <option value="">ã™ã¹ã¦</option>
            <option value="open">æœªæ±ºæ¸ˆ</option>
            <option value="closed">æ±ºæ¸ˆæ¸ˆ</option>
          </select>
        </div>

      </div>

      <div class="filter-actions">
        <button class="btn-xs" onclick="clearFilters()">ã‚¯ãƒªã‚¢</button>
        <button class="btn-xs btn-xs-primary" onclick="loadHistory()">æ¤œç´¢</button>
      </div>

    </section>

    <!-- è¦ªå±¥æ­´ -->
    <section class="table-card">
      <div class="table-header-row">
        <div class="table-title">è¦ªå£åº§å±¥æ­´ï¼ˆMAMï¼‰</div>
        <div class="table-meta" id="metaParent">0ä»¶</div>
      </div>

      <table>
        <thead>
          <tr>
            <th>ID</th>
            <th>Symbol</th>
            <th>Lot</th>
            <th>Entry</th>
            <th>Close</th>
            <th>Profit</th>
            <th>Opened</th>
            <th>Closed</th>
          </tr>
        </thead>
        <tbody id="parentBody"></tbody>
      </table>
    </section>

    <!-- å­å±¥æ­´ -->
    <section class="table-card">
      <div class="table-header-row">
        <div class="table-title">å­å£åº§å±¥æ­´ï¼ˆPAMï¼‰</div>
        <div class="table-meta" id="metaChildren">0ä»¶</div>
      </div>

      <table>
        <thead>
          <tr>
            <th>ID</th>
            <th>User</th>
            <th>Symbol</th>
            <th>Lot</th>
            <th>Entry</th>
            <th>Close</th>
            <th>Profit</th>
            <th>Opened</th>
            <th>Closed</th>
          </tr>
        </thead>
        <tbody id="childBody"></tbody>
      </table>
    </section>

  </div>
</main>

<!-- Toast -->
<div class="toast" id="toast"><span id="toast-text"></span></div>



<script>
const API_BASE = "https://api.exchange-template.com";

/* â–¼ ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆé–¢æ•° */
function fmtDate(d) {
  if (!d) return "-";
  const date = new Date(d);
  const y = date.getFullYear();
  const m = ("0" + (date.getMonth()+1)).slice(-2);
  const day = ("0" + date.getDate()).slice(-2);
  const h = ("0" + date.getHours()).slice(-2);
  const min = ("0" + date.getMinutes()).slice(-2);
  const s = ("0" + date.getSeconds()).slice(-2);
  return `${y}/${m}/${day} ${h}:${min}:${s}`;
}

function fmtNum(n, digits = 2) {
  return Number(n).toFixed(digits);
}

function fmtLot(n) {
  return Number(n).toFixed(4);
}

/* â–¼ API GET */
async function apiGet(path) {
  const res = await fetch(API_BASE + path, { credentials: "include" });
  const txt = await res.text();
  if (!res.ok) throw new Error(txt);
  return JSON.parse(txt);
}

function showToast(msg) {
  const t = document.getElementById("toast");
  document.getElementById("toast-text").textContent = msg;
  t.classList.add("show");
  setTimeout(() => t.classList.remove("show"), 2000);
}

async function loadGroups() {
  const groups = await apiGet("/admin/groups");
  const sel = document.getElementById("groupSelect");
  sel.innerHTML = "";
  groups.forEach(g => {
    sel.innerHTML += `<option value="${g.id}">${g.name} (ID:${g.id})</option>`;
  });
}

function clearFilters() {
  document.getElementById("fSymbol").value = "";
  document.getElementById("fUserId").value = "";
  document.getElementById("fStatus").value = "";
}

async function loadHistory() {
  const gid = document.getElementById("groupSelect").value;
  if (!gid) return showToast("ã‚°ãƒ«ãƒ¼ãƒ—IDã‚’é¸æŠã—ã¦ãã ã•ã„");

  const data = await apiGet(`/admin/system/history/${gid}`);

  let parent = data.parent;
  let children = data.children;

  const symbol = document.getElementById("fSymbol").value.trim().toUpperCase();
  const userId = Number(document.getElementById("fUserId").value);
  const status = document.getElementById("fStatus").value;

  /* â–¼ ãƒ•ã‚£ãƒ«ã‚¿ */
  if (symbol !== "") {
    parent = parent.filter(t => t.symbol === symbol);
    children = children.filter(t => t.symbol === symbol);
  }

  if (!isNaN(userId) && userId > 0) {
    children = children.filter(t => t.userId === userId);
  }

  if (status === "open") {
    parent = parent.filter(t => t.closePrice === null);
    children = children.filter(t => t.closePrice === null);
  } else if (status === "closed") {
    parent = parent.filter(t => t.closePrice !== null);
    children = children.filter(t => t.closePrice !== null);
  }

  /* â–¼ è¦ªå±¥æ­´æç”» */
  const pBody = document.getElementById("parentBody");
  pBody.innerHTML = "";
  document.getElementById("metaParent").textContent = `${parent.length}ä»¶`;

  if (!parent.length) {
    pBody.innerHTML = `<tr><td colspan="8" class="muted">ãªã—</td></tr>`;
  } else {
    parent.forEach(t => {
      pBody.innerHTML += `
        <tr>
          <td>${t.id}</td>
          <td>${t.symbol}</td>
          <td>${fmtLot(t.size)}</td>
          <td>${fmtNum(t.entryPrice)}</td>
          <td>${fmtNum(t.closePrice)}</td>
          <td class="${t.profit >= 0 ? 'profit' : 'loss'}">${fmtNum(t.profit)}</td>
          <td>${fmtDate(t.openedAt)}</td>
          <td>${fmtDate(t.closedAt)}</td>
        </tr>`;
    });
  }

  /* â–¼ å­å±¥æ­´æç”» */
  const cBody = document.getElementById("childBody");
  cBody.innerHTML = "";
  document.getElementById("metaChildren").textContent = `${children.length}ä»¶`;

  if (!children.length) {
    cBody.innerHTML = `<tr><td colspan="9" class="muted">ãªã—</td></tr>`;
  } else {
    children.forEach(t => {
      cBody.innerHTML += `
        <tr>
          <td>${t.id}</td>
          <td>${t.user.name} (ID:${t.userId})</td>
          <td>${t.symbol}</td>
          <td>${fmtLot(t.size)}</td>
          <td>${fmtNum(t.entryPrice)}</td>
          <td>${fmtNum(t.closePrice)}</td>
          <td class="${t.profit >= 0 ? 'profit' : 'loss'}">${fmtNum(t.profit)}</td>
          <td>${fmtDate(t.openedAt)}</td>
          <td>${fmtDate(t.closedAt)}</td>
        </tr>`;
    });
  }

  showToast("å±¥æ­´ã‚’èª­ã¿è¾¼ã¿ã¾ã—ãŸ");
}

loadGroups();
</script>

</body>
</html>
