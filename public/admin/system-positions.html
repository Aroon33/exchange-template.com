<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>CryptoX Admin - ã‚·ã‚¹ãƒ†ãƒ ãƒã‚¸ã‚·ãƒ§ãƒ³ï¼†æ±ºæ¸ˆç®¡ç†</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <link rel="stylesheet" href="../assets/css/style.css">
  <link rel="stylesheet" href="../assets/css/admin.css">

  <style>
    th, td {
      padding: 6px 8px;
      font-size: 13px;
    }
    .btn-mini {
      padding: 3px 6px;
      font-size: 11px;
      margin-left: 4px;
    }
  </style>
</head>

<body>

<!-- SIDEBAR -->
<aside class="sidebar">
  <div class="sidebar-title">ãƒ¡ãƒ‹ãƒ¥ãƒ¼</div>
  <ul class="nav-list">
    <li class="nav-item"><a href="index.html" class="nav-link">ğŸ  ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰</a></li>
    <li class="nav-item"><a href="tickets.html" class="nav-link">ğŸ’¬ å•ã„åˆã‚ã›ç®¡ç†</a></li>
    <li class="nav-item"><a href="users.html" class="nav-link">ğŸ‘¥ ãƒ¦ãƒ¼ã‚¶ãƒ¼ä¸€è¦§</a></li>
    <li class="nav-item"><a href="trades.html" class="nav-link">ğŸ“Š å–å¼•çŠ¶æ³</a></li>
    <li class="nav-item"><a href="kyc.html" class="nav-link">ğŸªª KYCçŠ¶æ³</a></li>
    <li class="nav-item"><a href="deposit.html" class="nav-link">â• å…¥é‡‘ç”³è«‹</a></li>
    <li class="nav-item"><a href="withdraw.html" class="nav-link">â– å‡ºé‡‘ç”³è«‹</a></li>
    <li class="nav-item"><a href="group.html" class="nav-link">ğŸ§© ã‚°ãƒ«ãƒ¼ãƒ—ç®¡ç†</a></li>
    <li class="nav-item"><a href="settings.html" class="nav-link">âš™ï¸ ã‚·ã‚¹ãƒ†ãƒ è¨­å®š</a></li>
    <li class="nav-item"><a href="system-positions.html" class="nav-link active">ğŸ“ˆ ãƒã‚¸ã‚·ãƒ§ãƒ³ç®¡ç†</a></li>
    <li class="nav-item"><a href="system-history.html" class="nav-link">ğŸ“œ ã‚·ã‚¹ãƒ†ãƒ å±¥æ­´</a></li>
  </ul>
</aside>

<!-- HEADER -->
<header class="admin-header">
  <div class="admin-header-left">
    <div class="admin-logo-badge">AX</div>
    <div>
      <div class="admin-logo-text">Admin Console</div>
      <div class="admin-logo-sub">ã‚·ã‚¹ãƒ†ãƒ ãƒã‚¸ã‚·ãƒ§ãƒ³ç®¡ç†</div>
    </div>
  </div>
  <div class="admin-header-right"></div>
</header>

<!-- MAIN -->
<main class="admin-main">
  <div class="admin-main-inner">

    <div class="page-title">ã‚·ã‚¹ãƒ†ãƒ ãƒã‚¸ã‚·ãƒ§ãƒ³ï¼ˆOPENï¼‰ï¼‹ æ±ºæ¸ˆæ“ä½œ</div>

    <!-- â–¼ ã‚°ãƒ«ãƒ¼ãƒ—é¸æŠ -->
    <section class="filters-card">
      <div class="filters-grid">
        <div class="field">
          <label>ã‚°ãƒ«ãƒ¼ãƒ—ID</label>
          <select id="groupSelect"></select>
        </div>
      </div>

      <div class="filter-actions">
        <button class="btn-xs btn-xs-primary" onclick="loadPositions()">æ›´æ–°</button>
        <button class="btn-xs btn-danger" onclick="closeGroupAll()">âš  å…¨æ±ºæ¸ˆï¼ˆè¦ªï¼‹å­ï¼‰</button>
      </div>
    </section>

    <!-- â–¼ è¦ªå£åº§ -->
    <section class="table-card">
      <div class="table-header-row">
        <div class="table-title">è¦ªå£åº§ãƒã‚¸ã‚·ãƒ§ãƒ³ï¼ˆMAMï¼‰</div>
        <div class="table-meta" id="metaParent"></div>
      </div>

      <table>
        <thead>
          <tr>
            <th>Symbol</th>
            <th>Lot</th>
            <th>Entry</th>
            <th>Current</th>
            <th>PnL</th>
            <th>æ“ä½œ</th>
          </tr>
        </thead>
        <tbody id="parentBody"></tbody>
      </table>
    </section>

    <!-- â–¼ å­å£åº§ -->
    <section class="table-card">
      <div class="table-header-row">
        <div class="table-title">å­å£åº§ãƒã‚¸ã‚·ãƒ§ãƒ³ï¼ˆPAMï¼‰</div>
        <div class="table-meta" id="metaChildren"></div>
      </div>

      <table>
        <thead>
          <tr>
            <th>User</th>
            <th>Symbol</th>
            <th>Lot</th>
            <th>Entry</th>
            <th>Current</th>
            <th>PnL</th>
            <th>æ“ä½œ</th>
          </tr>
        </thead>
        <tbody id="childBody"></tbody>
      </table>
    </section>

  </div>
</main>

<!-- Toast -->
<div class="toast" id="toast"><span id="toast-text"></span></div>

<script>
const API = "https://api.exchange-template.com";

async function apiGet(path){
  const r = await fetch(API + path, { credentials:"include" });
  const t = await r.text();
  if(!r.ok) throw new Error(t);
  return JSON.parse(t);
}

async function apiPost(path){
  const r = await fetch(API + path, { method:"POST", credentials:"include" });
  const t = await r.text();
  if(!r.ok) throw new Error(t);
  return JSON.parse(t);
}

function toast(msg){
  const t = document.getElementById("toast");
  document.getElementById("toast-text").textContent = msg;
  t.classList.add("show");
  setTimeout(()=>t.classList.remove("show"), 1800);
}

/* â–¼ ã‚°ãƒ«ãƒ¼ãƒ—ä¸€è¦§èª­ã¿è¾¼ã¿ */
async function loadGroups(){
  const list = await apiGet("/admin/groups");
  const sel = document.getElementById("groupSelect");
  sel.innerHTML = "";
  list.forEach(g=>{
    sel.innerHTML += `<option value="${g.id}">${g.name} (ID:${g.id})</option>`;
  });
}

async function loadPositions(){
  const gid = document.getElementById("groupSelect").value;
  if(!gid) return;

  const res = await apiGet(`/admin/system/positions/${gid}`);

  renderParent(res.parent);
  renderChildren(res.children);
}

/* â–¼ è¦ªãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚° */
function renderParent(list){
  const body = document.getElementById("parentBody");
  body.innerHTML = "";
  document.getElementById("metaParent").textContent = `${list.length}ä»¶`;

  if(!list.length){
    body.innerHTML = `<tr><td colspan="6" class="muted">ãªã—</td></tr>`;
    return;
  }

  list.forEach(p=>{
    body.innerHTML += `
      <tr>
        <td>${p.symbol}</td>
        <td>${p.size}</td>
        <td>${p.entryPrice}</td>
        <td>${p.currentPrice.toFixed(5)}</td>
        <td class="${p.unrealizedPnl>=0?'profit':'loss'}">${p.unrealizedPnl.toFixed(5)}</td>
        <td>
          <button class="btn-mini btn-danger" onclick="closeGroupSymbol('${p.symbol}')">
            ${p.symbol} ã‚’æ±ºæ¸ˆ
          </button>
        </td>
      </tr>
    `;
  });
}

/* â–¼ å­ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚° */
function renderChildren(list){
  const body = document.getElementById("childBody");
  body.innerHTML = "";
  document.getElementById("metaChildren").textContent = `${list.length}ä»¶`;

  if(!list.length){
    body.innerHTML = `<tr><td colspan="7" class="muted">ãªã—</td></tr>`;
    return;
  }

  list.forEach(c=>{
    body.innerHTML += `
      <tr>
        <td>${c.userName} (ID:${c.userId})</td>
        <td>${c.symbol}</td>
        <td>${c.size}</td>
        <td>${c.entryPrice}</td>
        <td>${c.currentPrice.toFixed(5)}</td>
        <td class="${c.unrealizedPnl>=0?'profit':'loss'}">${c.unrealizedPnl.toFixed(5)}</td>
        <td>
          <button class="btn-mini btn-danger" onclick="closeUserSymbol(${c.userId}, '${c.symbol}')">
            ${c.symbol} æ±ºæ¸ˆ
          </button>
          <button class="btn-mini btn-warning" onclick="closeUser(${c.userId})">
            ãƒ¦ãƒ¼ã‚¶ãƒ¼å…¨æ±ºæ¸ˆ
          </button>
        </td>
      </tr>
    `;
  });
}

/* â–¼ æ±ºæ¸ˆæ©Ÿèƒ½å®Ÿè£… */

async function closeGroupAll(){
  const gid = document.getElementById("groupSelect").value;
  if(!gid) return;
  if(!confirm("âš  ã‚°ãƒ«ãƒ¼ãƒ—å…¨ãƒã‚¸ã‚·ãƒ§ãƒ³ã‚’æ±ºæ¸ˆã—ã¾ã™ã‹ï¼Ÿ")) return;

  await apiPost(`/system/close-group/${gid}`);
  toast("ã‚°ãƒ«ãƒ¼ãƒ—å…¨æ±ºæ¸ˆã—ã¾ã—ãŸ");
  loadPositions();
}

async function closeGroupSymbol(symbol){
  const gid = document.getElementById("groupSelect").value;
  if(!gid) return;
  if(!confirm(`âš  ${symbol} ã‚’æ±ºæ¸ˆã—ã¾ã™ã‹ï¼Ÿ`)) return;

  await apiPost(`/system/close-group/${gid}/${symbol}`);
  toast(`${symbol} ã‚’æ±ºæ¸ˆã—ã¾ã—ãŸ`);
  loadPositions();
}

async function closeUser(userId){
  if(!confirm(`âš  ãƒ¦ãƒ¼ã‚¶ãƒ¼ ${userId} ã®å…¨é€šè²¨ã‚’æ±ºæ¸ˆã—ã¾ã™ã‹ï¼Ÿ`)) return;

  await apiPost(`/system/close-user/${userId}`);
  toast(`ãƒ¦ãƒ¼ã‚¶ãƒ¼ ${userId} å…¨æ±ºæ¸ˆã—ã¾ã—ãŸ`);
  loadPositions();
}

async function closeUserSymbol(userId, symbol){
  if(!confirm(`âš  ãƒ¦ãƒ¼ã‚¶ãƒ¼ ${userId} ã® ${symbol} ã‚’æ±ºæ¸ˆã—ã¾ã™ã‹ï¼Ÿ`)) return;

  await apiPost(`/system/close-user/${userId}/${symbol}`);
  toast(`ãƒ¦ãƒ¼ã‚¶ãƒ¼ ${userId} ã® ${symbol} ã‚’æ±ºæ¸ˆã—ã¾ã—ãŸ`);
  loadPositions();
}

/* åˆæœŸåŒ– */
loadGroups().then(loadPositions);
</script>

</body>
</html>
