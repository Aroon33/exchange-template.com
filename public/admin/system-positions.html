<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>CryptoX Admin - ã‚·ã‚¹ãƒ†ãƒ ãƒã‚¸ã‚·ãƒ§ãƒ³ï¼†æ±ºæ¸ˆç®¡ç†</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <link rel="stylesheet" href="../assets/css/style.css">
  <link rel="stylesheet" href="../assets/css/admin.css">

  <style>
    th, td {
      padding: 6px 8px;
      font-size: 13px;
    }
    .btn-mini {
      padding: 3px 6px;
      font-size: 11px;
      margin-left: 4px;
    }
    .profit { color:#059669; font-weight:bold; }
    .loss   { color:#dc2626; font-weight:bold; }
  </style>
</head>

<body>

<!-- SIDEBAR -->
<aside class="sidebar">
  <div class="sidebar-title">ãƒ¡ãƒ‹ãƒ¥ãƒ¼</div>
  <ul class="nav-list">
    <li class="nav-item"><a href="index.html" class="nav-link">ğŸ  ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰</a></li>
    <li class="nav-item"><a href="tickets.html" class="nav-link">ğŸ’¬ å•ã„åˆã‚ã›ç®¡ç†</a></li>
    <li class="nav-item"><a href="users.html" class="nav-link">ğŸ‘¥ ãƒ¦ãƒ¼ã‚¶ãƒ¼ä¸€è¦§</a></li>
    <li class="nav-item"><a href="trades.html" class="nav-link">ğŸ“Š å–å¼•çŠ¶æ³</a></li>
    <li class="nav-item"><a href="kyc.html" class="nav-link">ğŸ“‹ KYCçŠ¶æ³</a></li>
    <li class="nav-item"><a href="deposit.html" class="nav-link">â• å…¥é‡‘ç”³è«‹</a></li>
    <li class="nav-item"><a href="withdraw.html" class="nav-link">â– å‡ºé‡‘ç”³è«‹</a></li>
    <li class="nav-item"><a href="group.html" class="nav-link">ğŸ§© ã‚°ãƒ«ãƒ¼ãƒ—ç®¡ç†</a></li>
    <li class="nav-item"><a href="settings.html" class="nav-link">âš™ï¸ ã‚·ã‚¹ãƒ†ãƒ è¨­å®š</a></li>
    <li class="nav-item"><a href="system-positions.html" class="nav-link">ğŸ“ˆ ã‚·ã‚¹ãƒ†ãƒ ãƒã‚¸ã‚·ãƒ§ãƒ³</a></li>
    <li class="nav-item"><a href="system-history.html" class="nav-link active">ğŸ“œ ã‚·ã‚¹ãƒ†ãƒ å±¥æ­´</a></li>
    <li class="nav-item"><a href="deposit-bank-accounts.html" class="nav-link active">ğŸ“œ éŠ€è¡Œç®¡ç†</a></li>
    <li class="nav-item"><a href="deposit-bank-accounts-edit.html" class="nav-link active">ğŸ“œ å£åº§ç™»éŒ²</a></li>
    <li class="nav-item"><a href="deposit-crypto-address-form.html" class="nav-link active">ğŸ“œ ã‚¢ãƒ‰ãƒ¬ã‚¹ç™»éŒ²</a></li>
  </ul>
</aside>

<header class="admin-header">
  <div class="admin-header-left">
    <div class="admin-logo-badge">AX</div>
    <div>
      <div class="admin-logo-text">Admin Console</div>
      <div class="admin-logo-sub">ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰</div>
    </div>
  </div>
  <div class="admin-header-right">

<!-- â–¼ è¿½åŠ ï¼šã‚µã‚¤ãƒ‰ãƒãƒ¼ãƒˆã‚°ãƒ« -->
    <button class="sidebar-toggle" onclick="toggleSidebar()">â˜°</button> 
   <button class="btn btn-outline btn-sm" onclick="doLogout()">ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ</button>
  </div>
</header>

<!-- overlay -->
<div class="sidebar-overlay" onclick="closeSidebar()"></div>
<main class="admin-main">
  <div class="admin-main-inner">

    <div class="page-title">ãƒã‚¸ã‚·ãƒ§ãƒ³ç®¡ç†ï¼ˆOPENï¼‰ï¼‹ æ±ºæ¸ˆæ“ä½œ</div>

    <!-- â–¼ ã‚°ãƒ«ãƒ¼ãƒ—é¸æŠ -->
    <section class="filters-card">
      <div class="filters-grid">
        <div class="field">
          <label>ã‚°ãƒ«ãƒ¼ãƒ—ID</label>
          <select id="groupSelect"></select>
        </div>
      </div>

      <div class="filter-actions">
        <button class="btn-xs btn-xs-primary" onclick="loadPositions()">æ›´æ–°</button>
        <button class="btn-xs btn-danger" onclick="closeGroupAll()">âš  å…¨æ±ºæ¸ˆï¼ˆè¦ªï¼‹å­ï¼‰</button>
      </div>
    </section>

    <!-- â–¼ è¦ªå£åº§ -->
    <section class="table-card">
      <div class="table-header-row">
        <div class="table-title">è¦ªå£åº§ãƒã‚¸ã‚·ãƒ§ãƒ³ï¼ˆMAMï¼‰</div>
        <div class="table-meta" id="metaParent"></div>
      </div>

      <table>
        <thead>
          <tr>
            <th>æ—¥æ™‚</th>
            <th>Symbol</th>
            <th>Lot</th>
            <th>Entry</th>
            <th>Current</th>
            <th>PnL</th>
            <th>æ“ä½œ</th>
          </tr>
        </thead>
        <tbody id="parentBody"></tbody>
      </table>
    </section>

    <!-- â–¼ å­å£åº§ -->
    <section class="table-card">
      <div class="table-header-row">
        <div class="table-title">å­å£åº§ãƒã‚¸ã‚·ãƒ§ãƒ³ï¼ˆPAMï¼‰</div>
        <div class="table-meta" id="metaChildren"></div>
      </div>

      <table>
        <thead>
          <tr>
            <th>æ—¥æ™‚</th>
            <th>Symbol</th>
            <th>Lot</th>
            <th>Entry</th>
            <th>Current</th>
            <th>PnL</th>
            <th>æ“ä½œ</th>
            <th>ãƒ¦ãƒ¼ã‚¶ãƒ¼</th>
          </tr>
        </thead>
        <tbody id="childBody"></tbody>
      </table>
    </section>

  </div>
</main>

<!-- Toast -->
<div class="toast" id="toast"><span id="toast-text"></span></div>

<script>
const API = "https://api.exchange-template.com";

/* ------------------------
      API UTIL
------------------------ */
async function apiGet(path){
  const r = await fetch(API + path, { credentials:"include" });
  const t = await r.text();
  if(!r.ok) throw new Error(t);
  return JSON.parse(t);
}
async function apiPost(path){
  const r = await fetch(API + path, { method:"POST", credentials:"include" });
  const t = await r.text();
  if(!r.ok) throw new Error(t);
  return JSON.parse(t);
}

function toast(msg){
  const t = document.getElementById("toast");
  document.getElementById("toast-text").textContent = msg;
  t.classList.add("show");
  setTimeout(()=>t.classList.remove("show"), 1800);
}

/* ------------------------
      FORMATTERS
------------------------ */
function fmtDate(iso){
  if(!iso) return "-";
  return new Date(iso).toLocaleString("ja-JP",{hour12:false});
}

function fmt3(n){
  return Number(n).toFixed(3);
}

/* ------------------------
      GROUP LOAD
------------------------ */
async function loadGroups(){
  const list = await apiGet("/admin/groups");
  const sel = document.getElementById("groupSelect");
  sel.innerHTML = "";
  list.forEach(g=>{
    sel.innerHTML += `<option value="${g.id}">${g.name} (ID:${g.id})</option>`;
  });
}

/* ------------------------
      POSITION LOAD
------------------------ */
async function loadPositions(){
  const gid = document.getElementById("groupSelect").value;
  if(!gid) return;

  const res = await apiGet(`/admin/system/positions/${gid}`);

  renderParent(res.parent);
  renderChildren(res.children);
}

/* ----------------------------------------------------
      è¦ªå£åº§ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°ï¼ˆâ˜…æ—¥æ™‚ + å°æ•°ç‚¹3æ¡å¯¾å¿œï¼‰
---------------------------------------------------- */
function renderParent(list){
  const body = document.getElementById("parentBody");
  body.innerHTML = "";
  document.getElementById("metaParent").textContent = `${list.length}ä»¶`;

  if(!list.length){
    body.innerHTML = `<tr><td colspan="7" class="muted">ãªã—</td></tr>`;
    return;
  }

  list.forEach(p=>{
    const pnlClass = p.unrealizedPnl >= 0 ? "profit" : "loss";

    body.innerHTML += `
      <tr>
        <td>${fmtDate(p.openedAt)}</td>
        <td>${p.symbol}</td>
        <td>${fmt3(p.size)}</td>
        <td>${fmt3(p.entryPrice)}</td>
        <td>${fmt3(p.currentPrice)}</td>
        <td class="${pnlClass}">${fmt3(p.unrealizedPnl)}</td>
        <td>
          <button class="btn-mini btn-danger" onclick="closeGroupSymbol('${p.symbol}')">
            æ±ºæ¸ˆ
          </button>
        </td>
      </tr>
    `;
  });
}

/* ----------------------------------------------------
      å­å£åº§ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°ï¼ˆâ˜…æ—¥æ™‚ + å°æ•°ç‚¹3æ¡å¯¾å¿œï¼‰
---------------------------------------------------- */
function renderChildren(list){
  const body = document.getElementById("childBody");
  body.innerHTML = "";
  document.getElementById("metaChildren").textContent = `${list.length}ä»¶`;

  if(!list.length){
    body.innerHTML = `<tr><td colspan="8" class="muted">ãªã—</td></tr>`;
    return;
  }

  list.forEach(c=>{
    const pnlClass = c.unrealizedPnl >= 0 ? "profit" : "loss";

    body.innerHTML += `
      <tr>
        <td>${fmtDate(c.openedAt)}</td>
        <td>${c.symbol}</td>
        <td>${fmt3(c.size)}</td>
        <td>${fmt3(c.entryPrice)}</td>
        <td>${fmt3(c.currentPrice)}</td>
        <td class="${pnlClass}">${fmt3(c.unrealizedPnl)}</td>
        <td>
          <button class="btn-mini btn-danger" onclick="closeUserSymbol(${c.userId}, '${c.symbol}')">
            æ±ºæ¸ˆ
          </button>
          <button class="btn-mini btn-warning" onclick="closeUser(${c.userId})">
            å…¨æ±ºæ¸ˆ
          </button>
        </td>
        <td>${c.userName} (ID:${c.userId})</td>
      </tr>
    `;
  });
}

/* ----------------------------------------------------
      æ±ºæ¸ˆæ©Ÿèƒ½
---------------------------------------------------- */
async function closeGroupAll(){
  const gid = document.getElementById("groupSelect").value;
  if(!gid) return;
  if(!confirm("âš  ã‚°ãƒ«ãƒ¼ãƒ—å…¨ãƒã‚¸ã‚·ãƒ§ãƒ³ã‚’æ±ºæ¸ˆã—ã¾ã™ã‹ï¼Ÿ")) return;

  await apiPost(`/system/close-group/${gid}`);
  toast("ã‚°ãƒ«ãƒ¼ãƒ—å…¨æ±ºæ¸ˆã—ã¾ã—ãŸ");
  loadPositions();
}

async function closeGroupSymbol(symbol){
  const gid = document.getElementById("groupSelect").value;
  if(!gid) return;
  if(!confirm(`âš  ${symbol} ã‚’æ±ºæ¸ˆã—ã¾ã™ã‹ï¼Ÿ`)) return;

  await apiPost(`/system/close-group/${gid}/${symbol}`);
  toast(`${symbol} ã‚’æ±ºæ¸ˆã—ã¾ã—ãŸ`);
  loadPositions();
}

async function closeUser(userId){
  if(!confirm(`âš  ãƒ¦ãƒ¼ã‚¶ãƒ¼ ${userId} ã®å…¨é€šè²¨ã‚’æ±ºæ¸ˆã—ã¾ã™ã‹ï¼Ÿ`)) return;

  await apiPost(`/system/close-user/${userId}`);
  toast(`ãƒ¦ãƒ¼ã‚¶ãƒ¼ ${userId} å…¨æ±ºæ¸ˆã—ã¾ã—ãŸ`);
  loadPositions();
}

async function closeUserSymbol(userId, symbol){
  if(!confirm(`âš  ãƒ¦ãƒ¼ã‚¶ãƒ¼ ${userId} ã® ${symbol} ã‚’æ±ºæ¸ˆã—ã¾ã™ã‹ï¼Ÿ`)) return;

  await apiPost(`/system/close-user/${userId}/${symbol}`);
  toast(`ãƒ¦ãƒ¼ã‚¶ãƒ¼ ${userId} ã® ${symbol} ã‚’æ±ºæ¸ˆã—ã¾ã—ãŸ`);
  loadPositions();
}

/* åˆæœŸåŒ– */
loadGroups().then(loadPositions);
</script>

<script src="/admin/assets/js/admin-auth.js"></script>
<script src="/admin/assets/js/header-admin.js"></script>


</body>
</html>
