<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>CryptoX Admin - KYCç®¡ç†</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <link rel="stylesheet" href="../assets/css/style.css">
  <link rel="stylesheet" href="../assets/css/admin.css">
</head>
<body>

  <!-- SIDEBAR -->
  <aside class="sidebar">
    <div class="sidebar-title">ãƒ¡ãƒ‹ãƒ¥ãƒ¼</div>
    <ul class="nav-list">
      <li class="nav-item"><a href="index.html" class="nav-link">ğŸ  ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰</a></li>
      <li class="nav-item"><a href="tickets.html" class="nav-link">ğŸ’¬ å•ã„åˆã‚ã›ç®¡ç†</a></li>
      <li class="nav-item"><a href="users.html" class="nav-link">ğŸ‘¥ ãƒ¦ãƒ¼ã‚¶ãƒ¼ä¸€è¦§</a></li>
      <li class="nav-item"><a href="trades.html" class="nav-link">ğŸ“Š å–å¼•çŠ¶æ³</a></li>
      <li class="nav-item"><a href="kyc.html" class="nav-link active">ğŸ“‹ KYCçŠ¶æ³</a></li>
      <li class="nav-item"><a href="deposit.html" class="nav-link">â• å…¥é‡‘ç”³è«‹</a></li>
      <li class="nav-item"><a href="withdraw.html" class="nav-link">â– å‡ºé‡‘ç”³è«‹</a></li>
      <li class="nav-item"><a href="group.html" class="nav-link">ğŸ§© ã‚°ãƒ«ãƒ¼ãƒ—ç®¡ç†</a></li>
      <li class="nav-item"><a href="settings.html" class="nav-link">âš™ï¸ ã‚·ã‚¹ãƒ†ãƒ è¨­å®š</a></li>
    </ul>
  </aside>

  <!-- HEADER -->
  <header class="admin-header">
    <div class="admin-header-left">
      <div class="admin-logo-badge">AX</div>
      <div>
        <div class="admin-logo-text">Admin Console</div>
        <div class="admin-logo-sub">KYCç®¡ç†</div>
      </div>
    </div>
  </header>

  <!-- MAIN -->
  <main class="admin-main">
    <div class="admin-main-inner">

      <div class="page-title">KYCç”³è«‹ä¸€è¦§</div>

      <!-- ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ -->
      <div style="margin:12px 0;">
        <select id="status-filter" class="btn-sm">
          <option value="ALL">ã™ã¹ã¦</option>
          <option value="0">æœªæå‡º / NONE</option>
          <option value="1">æå‡ºæ¸ˆã¿</option>
          <option value="2">å¯©æŸ»ä¸­</option>
          <option value="3">æ‰¿èªï¼ˆä¸€æ¬¡ï¼‰</option>
          <option value="4">å¦èª</option>
          <option value="5">å®Œäº†</option>
        </select>
        <button class="btn-sm" id="reload-btn">å†èª­ã¿è¾¼ã¿</button>
      </div>

      <!-- TABLE -->
      <div class="card">
        <table class="table" style="width:100%; font-size:13px;">
          <thead>
            <tr>
              <th>ID</th>
              <th>ç”³è«‹æ—¥æ™‚</th>
              <th>åå‰</th>
              <th>è¡¨é¢ç”»åƒ</th>
              <th>è£é¢ç”»åƒ</th>
              <th>æ›´æ–°æ—¥æ™‚</th>
              <th>ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹</th>
              <th>å¤‰æ›´</th>
            </tr>
          </thead>
          <tbody id="kyc-table-body">
            <tr><td colspan="8" style="text-align:center;color:#777;">èª­ã¿è¾¼ã¿ä¸­...</td></tr>
          </tbody>
        </table>
      </div>

    </div>
  </main>

  <div class="toast" id="toast"></div>

<script>
  const API_BASE = "https://api.exchange-template.com";
  let allKyc = [];

  function showToast(msg) {
    const t = document.getElementById("toast");
    t.textContent = msg;
    t.classList.add("show");
    setTimeout(() => t.classList.remove("show"), 2000);
  }

  function formatDate(s) {
    if (!s) return "-";
    return new Date(s).toLocaleString("ja-JP", { hour12:false });
  }

  async function apiGet(path) {
    const res = await fetch(API_BASE + path, { credentials:"include" });
    const txt = await res.text();
    if (!res.ok) throw new Error(txt);
    return JSON.parse(txt);
  }

  async function apiPost(path, body) {
    const res = await fetch(API_BASE + path, {
      method:"POST",
      credentials:"include",
      headers:{ "Content-Type":"application/json" },
      body: JSON.stringify(body)
    });
    const txt = await res.text();
    if (!res.ok) throw new Error(txt);
    return JSON.parse(txt);
  }

  async function changeStatus(id) {
    const level = Number(prompt("æ–°ã—ã„ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ï¼ˆ0ã€œ5ï¼‰ã‚’å…¥åŠ›ï¼š"));
    if (isNaN(level) || level < 0 || level > 5) {
      showToast("ç„¡åŠ¹ãªã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã§ã™");
      return;
    }

    try {
      await apiPost("/kyc/admin/set-status", { id, level });
      showToast("æ›´æ–°ã—ã¾ã—ãŸ");
      loadKyc();
    } catch(e) {
      showToast("æ›´æ–°å¤±æ•—");
    }
  }

  function renderTable(list) {
    const tbody = document.getElementById("kyc-table-body");
    tbody.innerHTML = "";

    if (!list.length) {
      tbody.innerHTML =
        `<tr><td colspan="8" style="text-align:center;color:#777;">ãªã—</td></tr>`;
      return;
    }

    list.forEach(k => {
      const tr = document.createElement("tr");

      tr.innerHTML = `
        <td>${k.id}</td>
        <td>${formatDate(k.createdAt)}</td>
        <td>${k.name ?? "-"}</td>
        <td>
          ${k.frontUrl ? `<a href="${k.frontUrl}" target="_blank">è¡¨ç¤º</a>` : "-"}
        </td>
        <td>
          ${k.backUrl ? `<a href="${k.backUrl}" target="_blank">è¡¨ç¤º</a>` : "-"}
        </td>
        <td>${formatDate(k.updatedAt)}</td>
        <td>${k.statusText}</td>
        <td>
          <button class="btn-xs btn-xs-primary" onclick="changeStatus(${k.id})">
            æ›´æ–°
          </button>
        </td>
      `;

      tbody.appendChild(tr);
    });
  }

  function applyFilter() {
    const f = document.getElementById("status-filter").value;
    if (f === "ALL") {
      renderTable(allKyc);
    } else {
      renderTable(allKyc.filter(k => String(k.level) === f));
    }
  }

  async function loadKyc() {
    try {
      allKyc = await apiGet("/kyc/admin/list");
      applyFilter();
    } catch (e) {
      showToast("å–å¾—å¤±æ•—");
    }
  }

  document.getElementById("status-filter").addEventListener("change", applyFilter);
  document.getElementById("reload-btn").addEventListener("click", loadKyc);

  loadKyc();
</script>

</body>
</html>
