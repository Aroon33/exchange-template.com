<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>CryptoX Admin - å…¥é‡‘ç”³è«‹ç®¡ç†</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <link rel="stylesheet" href="../assets/css/style.css">
  <link rel="stylesheet" href="../assets/css/admin.css">

  <style>
/* =========================
   Responsive (Deposit)
========================= */
@media (max-width: 768px) {

  .thead-pc {
    display: none;
  }

  .thead-sp {
    display: table-header-group;
  }

  .pc-only {
    display: none;
  }

  .table td.actions,
  .table th.actions {
    display: none;
  }

  .deposit-row td {
    padding: 10px;
    font-size: 14px;
  }

  /* ===== Modal ===== */
  .modal {
    display: none;
    position: fixed;
    inset: 0;
    background: rgba(0,0,0,0.5);
    z-index: 999;
  }

  .modal-content {
    background: #fff;
    margin: 10% auto;
    width: 92%;
    border-radius: 8px;
    overflow: hidden;
  }

  .modal-header,
  .modal-footer {
    padding: 12px;
    border-bottom: 1px solid #eee;
  }

  .modal-footer {
    border-top: 1px solid #eee;
    display: flex;
    gap: 8px;
  }

  .modal-body {
    padding: 12px;
    font-size: 14px;
  }

  .modal-close {
    background: none;
    border: none;
    font-size: 20px;
  }
}

/* PC only */
@media (min-width: 769px) {
  .thead-sp {
    display: none;
  }
}
.admin-header {
  display: none;
  position: fixed;
  top: 0;
  left: 0;
  right: 0;
  height: 56px;
  background: #111;
  color: #fff;
  z-index: 1001;
  align-items: center;
  justify-content: space-between;
  padding: 0 12px;
}

.hamburger {
  font-size: 22px;
  background: none;
  border: none;
  color: #fff;
}

.sidebar {
  width: 240px;
}

.sidebar-overlay {
  display: none;
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,0.5);
  z-index: 1000;
}

@media (max-width: 768px) {
  .admin-header {
    display: flex;
  }

  .sidebar {
    position: fixed;
    top: 0;
    left: -240px;
    height: 100%;
    transition: left 0.3s ease;
    z-index: 1002;
  }

  .sidebar.open {
    left: 0;
  }

  .sidebar-overlay.show {
    display: block;
  }

  .admin-main {
    margin-top: 56px;
  }
}

  </style>
</head>

<body>
 


<main class="admin-main">
  <div class="admin-main-inner">

    <div class="page-title">å…¥é‡‘ç”³è«‹ä¸€è¦§</div>

    <div style="margin:12px 0;">
      <select id="status-filter" class="btn-sm">
        <option value="ALL">ã™ã¹ã¦</option>
        <option value="PENDING">ç”³è«‹ä¸­</option>
        <option value="CONFIRMING">ç¢ºèªä¸­</option>
        <option value="COMPLETED">å®Œäº†</option>
        <option value="CANCELED">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</option>
      </select>
      <button class="btn-sm" id="reload-btn">å†èª­ã¿è¾¼ã¿</button>
    </div>

    <div class="card">
      <table class="table" style="width:100%; font-size:13px;">

        <!-- PC -->
        <thead class="thead-pc">
          <tr>
            <th>ID</th>
            <th>ç”³è«‹æ—¥æ™‚</th>
            <th>åå‰</th>
            <th>ç¨®åˆ¥</th>
            <th>é€šè²¨</th>
            <th>ç”³è«‹é‡‘é¡</th>
            <th>å…¥é‡‘é¡</th>
            <th>æ›´æ–°æ—¥æ™‚</th>
            <th>ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹</th>
            <th class="actions">æ“ä½œ</th>
          </tr>
        </thead>

        <!-- SP -->
        <thead class="thead-sp">
          <tr>
            <th>å…¥é‡‘</th>
          </tr>
        </thead>

        <tbody id="deposit-table-body">
          <tr>
            <td colspan="100%" style="text-align:center;">èª­ã¿è¾¼ã¿ä¸­...</td>
          </tr>
        </tbody>
      </table>
    </div>

  </div>
</main>

<!-- =========================
   Modal (Mobile)
========================= -->
<div id="deposit-modal" class="modal">
  <div class="modal-content">
    <div class="modal-header">
      <span>å…¥é‡‘è©³ç´°</span>
      <button class="modal-close" onclick="closeDepositModal()">Ã—</button>
    </div>
    <div class="modal-body" id="modal-body"></div>
    <div class="modal-footer" id="modal-footer"></div>
  </div>
</div>

<div class="toast" id="toast"></div>
<script>
const API_BASE = "https://api.exchange-template.com";

/* =========================
   Utils
========================= */
function showToast(msg) {
  const t = document.getElementById("toast");
  t.textContent = msg;
  t.classList.add("show");
  setTimeout(() => t.classList.remove("show"), 2000);
}

function formatDate(v) {
  return v ? new Date(v).toLocaleString("ja-JP", { hour12:false }) : "-";
}

function formatAmount(v, type="JPY") {
  const n = Number(v);
  if (isNaN(n)) return "-";
  return type === "CRYPTO" ? n.toFixed(4) : Math.floor(n).toLocaleString("ja-JP");
}

/* =========================
   API
========================= */
async function apiGet(path) {
  const r = await fetch(API_BASE + path, { credentials:"include" });
  if (!r.ok) throw new Error();
  return r.json();
}

async function apiPost(path, body) {
  const r = await fetch(API_BASE + path, {
    method:"POST",
    credentials:"include",
    headers:{ "Content-Type":"application/json" },
    body: JSON.stringify(body),
  });
  if (!r.ok) throw new Error();
}

/* =========================
   Actions
========================= */
async function approveDeposit(id) {
  await apiPost("/deposit/approve", { id });
  showToast("æ‰¿èªã—ã¾ã—ãŸ");
  loadDeposits();
}

async function sendDepositAddress(id) {
  if (!confirm("å…¥é‡‘ã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’é€ä¿¡ã—ã¾ã™ã‹ï¼Ÿ")) return;
  await apiPost("/deposit/assign-crypto", { id });
  showToast("å…¥é‡‘ã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’é€ä¿¡ã—ã¾ã—ãŸ");
  loadDeposits();
}

function openChat(userId) {
  location.href = `tickets.html?user=${userId}`;
}

/* =========================
   Modal
========================= */
function openDepositModal(t) {
  document.getElementById("modal-body").innerHTML = `
    <div>IDï¼š${t.id}</div>
    <div>ãƒ¦ãƒ¼ã‚¶ãƒ¼ï¼š${t.user?.name ?? "-"}</div>
    <div>é€šè²¨ï¼š${t.currency}</div>
    <div>é‡‘é¡ï¼š${t.cryptoAmount ?? t.amount}</div>
    <div>çŠ¶æ…‹ï¼š${t.status}</div>
    <div>${formatDate(t.createdAt)}</div>
  `;

  document.getElementById("modal-footer").innerHTML = `
    ${t.status==="PENDING" && t.method==="CRYPTO"
      ? `<button class="btn" onclick="sendDepositAddress(${t.id})">ã‚¢ãƒ‰ãƒ¬ã‚¹é€ä¿¡</button>` : ""}
    ${t.status==="CONFIRMING"
      ? `<button class="btn" onclick="approveDeposit(${t.id})">ç€é‡‘ç¢ºèª</button>` : ""}
    <button class="btn" onclick="openChat(${t.user?.id})">ãƒãƒ£ãƒƒãƒˆ</button>
  `;

  document.getElementById("deposit-modal").style.display="block";
}

function closeDepositModal() {
  document.getElementById("deposit-modal").style.display="none";
}

/* =========================
   Render
========================= */
function renderTable(list) {
  const tbody = document.getElementById("deposit-table-body");
  tbody.innerHTML = "";

  if (!list.length) {
    tbody.innerHTML = `<tr><td colspan="100%" style="text-align:center;">ç”³è«‹ãªã—</td></tr>`;
    return;
  }

  list.forEach(t => {
    const isCrypto = t.cryptoAmount && Number(t.cryptoAmount) > 0;
    const currency = isCrypto ? t.currency : "JPY";
    const amount = isCrypto
      ? `${formatAmount(t.cryptoAmount,"CRYPTO")} ${currency}`
      : `${formatAmount(t.amount)} JPY`;

    tbody.insertAdjacentHTML("beforeend", `
<tr class="deposit-row"
    onclick="if(window.innerWidth<=900){openDepositModal(${JSON.stringify(t)})}"
    style="cursor:pointer;">

  <td>
    <div>ID:${t.id}</div>
    <div>${t.user?.name ?? "-"}</div>
    <div>${currency}</div>
    <div>${amount}</div>
    <div>${t.status}</div>
  </td>

  <td class="pc-only">${formatDate(t.createdAt)}</td>
  <td class="pc-only">${t.user?.name ?? "-"}</td>
  <td class="pc-only">${t.method}</td>
  <td class="pc-only">${currency}</td>
  <td class="pc-only">${formatAmount(t.amount)} JPY</td>
  <td class="pc-only">${amount}</td>
  <td class="pc-only">${formatDate(t.updatedAt)}</td>
  <td class="pc-only">${t.status}</td>

  <td class="actions pc-only">
    ${t.status==="PENDING" && t.method==="CRYPTO"
      ? `<button onclick="event.stopPropagation();sendDepositAddress(${t.id})">é€ä¿¡</button>` : ""}
    ${t.status==="CONFIRMING"
      ? `<button onclick="event.stopPropagation();approveDeposit(${t.id})">ç¢ºèª</button>` : ""}
    <button onclick="event.stopPropagation();openChat(${t.user?.id})">ğŸ’¬</button>
  </td>
</tr>
`);
  });
}

/* =========================
   Load
========================= */
async function loadDeposits() {
  const status = document.getElementById("status-filter").value;
  let list = await apiGet("/deposit/all");
  if (status === "PENDING") list = await apiGet("/deposit/pending");
  else if (status !== "ALL") list = list.filter(t=>t.status===status);
  renderTable(list);
}

document.getElementById("status-filter").addEventListener("change", loadDeposits);
document.getElementById("reload-btn").addEventListener("click", loadDeposits);
loadDeposi
</script>

<script src="/admin/assets/js/admin-auth.js"></script>
<script src="/admin/assets/js/header-admin.js"></script>



</body>
</html>
