<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>CryptoX Admin - å•ã„åˆã‚ã›ç®¡ç†</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link rel="stylesheet" href="../assets/css/style.css">
  <link rel="stylesheet" href="../assets/css/admin.css">
</head>

<body>

<!-- SIDEBAR -->
<aside class="sidebar">
  <div class="sidebar-title">ãƒ¡ãƒ‹ãƒ¥ãƒ¼</div>
  <ul class="nav-list">
    <li class="nav-item"><a href="index.html" class="nav-link">ğŸ  ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰</a></li>
    <li class="nav-item"><a href="tickets.html" class="nav-link">ğŸ’¬ å•ã„åˆã‚ã›ç®¡ç†</a></li>
    <li class="nav-item"><a href="users.html" class="nav-link">ğŸ‘¥ ãƒ¦ãƒ¼ã‚¶ãƒ¼ä¸€è¦§</a></li>
    <li class="nav-item"><a href="trades.html" class="nav-link">ğŸ“Š å–å¼•çŠ¶æ³</a></li>
    <li class="nav-item"><a href="kyc.html" class="nav-link">ğŸ“‹ KYCçŠ¶æ³</a></li>
    <li class="nav-item"><a href="deposit.html" class="nav-link">â• å…¥é‡‘ç”³è«‹</a></li>
    <li class="nav-item"><a href="withdraw.html" class="nav-link">â– å‡ºé‡‘ç”³è«‹</a></li>
    <li class="nav-item"><a href="group.html" class="nav-link">ğŸ§© ã‚°ãƒ«ãƒ¼ãƒ—ç®¡ç†</a></li>
    <li class="nav-item"><a href="settings.html" class="nav-link">âš™ï¸ ã‚·ã‚¹ãƒ†ãƒ è¨­å®š</a></li>
    <li class="nav-item"><a href="system-positions.html" class="nav-link">ğŸ“ˆ ã‚·ã‚¹ãƒ†ãƒ ãƒã‚¸ã‚·ãƒ§ãƒ³</a></li>
    <li class="nav-item"><a href="system-history.html" class="nav-link active">ğŸ“œ ã‚·ã‚¹ãƒ†ãƒ å±¥æ­´</a></li>
  </ul>
</aside>

<header class="admin-header">
  <div class="admin-header-left">
    <div class="admin-logo-badge">AX</div>
    <div>
      <div class="admin-logo-text">Admin Console</div>
      <div class="admin-logo-sub">å•ã„åˆã‚ã›ç®¡ç†</div>
    </div>
  </div>
</header>

<main class="admin-main">
  <div class="admin-main-inner">
    <div class="page-title">å•ã„åˆã‚ã›ä¸€è¦§</div>

    <!-- ãƒ†ãƒ¼ãƒ–ãƒ« -->
    <div class="card">
      <table class="table" style="width:100%; font-size:13px;">
        <thead>
          <tr>
            <th>ID</th>
            <th>æ—¥æ™‚</th>
            <th>åå‰</th>
            <th>ä»¶å</th>
            <th>æœ€æ–°ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸</th>
            <th>ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹</th>
            <th>è¡¨ç¤º</th>
          </tr>
        </thead>
        <tbody id="ticket-table-body">
          <tr><td colspan="7" style="text-align:center;">èª­ã¿è¾¼ã¿ä¸­â€¦</td></tr>
        </tbody>
      </table>
    </div>

    <!-- å€‹åˆ¥ãƒãƒ£ãƒƒãƒˆè¡¨ç¤ºã‚¨ãƒªã‚¢ -->
    <div class="card" style="margin-top:20px;">
      <h3 id="chat-title">å•ã„åˆã‚ã›è©³ç´°</h3>
      <div id="chat-window" class="chat-window" style="height:300px; overflow-y:auto;">
        <div class="muted">å•ã„åˆã‚ã›ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚</div>
      </div>

      <div id="chat-input-area" style="display:none;">
        <textarea id="chat-input" class="chat-input" placeholder="è¿”ä¿¡å†…å®¹ã‚’å…¥åŠ›..."></textarea>
        <button class="btn btn-primary btn-sm" id="btn-send">è¿”ä¿¡</button>
      </div>
    </div>
  </div>
</main>

<div class="toast" id="toast"></div>

<script>
const API_BASE = "https://api.exchange-template.com";
let allTickets = [];
let currentTicketId = null;

function showToast(msg) {
  const t = document.getElementById("toast");
  t.textContent = msg;
  t.classList.add("show");
  setTimeout(() => t.classList.remove("show"), 2000);
}

function fmt(s) {
  return new Date(s).toLocaleString("ja-JP", { hour12:false });
}

async function apiGet(path) {
  const res = await fetch(API_BASE + path, { credentials:"include" });
  const txt = await res.text();
  if (!res.ok) throw new Error(txt);
  return JSON.parse(txt);
}

async function apiPost(path, body) {
  const res = await fetch(API_BASE + path, {
    method:"POST",
    credentials:"include",
    headers:{ "Content-Type":"application/json" },
    body:JSON.stringify(body)
  });
  const txt = await res.text();
  if (!res.ok) throw new Error(txt);
  return JSON.parse(txt);
}

async function loadTickets() {
  try {
    allTickets = await apiGet("/tickets/admin/all");
    renderTable();
  } catch(e) {
    showToast("èª­ã¿è¾¼ã¿å¤±æ•—");
  }
}

function renderTable() {
  const tbody = document.getElementById("ticket-table-body");
  tbody.innerHTML = "";

  if (!allTickets.length) {
    tbody.innerHTML = `<tr><td colspan="7" style="text-align:center;">ãªã—</td></tr>`;
    return;
  }

  allTickets.forEach(t => {
    const latestText = t.lastMessage 
      ? t.lastMessage.slice(0, 30) + "â€¦" 
      : "-";

    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td>${t.id}</td>
      <td>${fmt(t.createdAt)}</td>
      <td>${t.email}</td>
      <td>${t.title}</td>
      <td>${latestText}</td>
      <td>${t.status}</td>
      <td><button class="btn-xs btn-xs-primary" onclick="openChat(${t.id})">è¡¨ç¤º</button></td>
    `;
    tbody.appendChild(tr);
  });
}

async function openChat(ticketId) {
  currentTicketId = ticketId;

  const chatWindow = document.getElementById("chat-window");
  const chatTitle = document.getElementById("chat-title");

  try {
    const msgs = await apiGet(`/tickets/${ticketId}/messages`);

    chatTitle.textContent = `å•ã„åˆã‚ã›ID: ${ticketId}`;
    chatWindow.innerHTML = "";

    msgs.forEach(m => {
      const item = document.createElement("div");
      item.className = "chat-message " + (m.sender === "ADMIN" ? "admin" : "user");
      item.innerHTML = `
        <div class="chat-message-meta">${m.sender} ï¼ ${fmt(m.createdAt)}</div>
        <div class="chat-message-body">${m.message}</div>
      `;
      chatWindow.appendChild(item);
    });

    document.getElementById("chat-input-area").style.display = "block";
  } catch (e) {
    showToast("ãƒãƒ£ãƒƒãƒˆå–å¾—ã«å¤±æ•—");
  }
}

document.getElementById("btn-send").addEventListener("click", async () => {
  const body = document.getElementById("chat-input").value.trim();
  if (!body) return;

  try {
    await apiPost(`/tickets/admin/${currentTicketId}/reply`, { message: body });
    document.getElementById("chat-input").value = "";
    openChat(currentTicketId);
  } catch (e) {
    showToast("é€ä¿¡ã«å¤±æ•—");
  }
});

loadTickets();
</script>

</body>
</html>
