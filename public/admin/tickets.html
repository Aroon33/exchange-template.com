<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>問い合わせ管理</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<link rel="stylesheet" href="../assets/css/style.css">

<style>
/* =========================
   Layout
========================= */
.admin-container {
  display: flex;
  height: calc(100vh - 56px);
}

/* ===== Ticket List ===== */
.ticket-list {
  width: 360px;
  border-right: 1px solid #ddd;
  overflow-y: auto;
}

.ticket-list table {
  width: 100%;
  font-size: 13px;
}

/* ===== Chat ===== */
.chat-panel {
  flex: 1;
  display: flex;
  flex-direction: column;
}

.chat-header {
  padding: 10px;
  border-bottom: 1px solid #ddd;
  font-size: 14px;
  display: flex;
  justify-content: space-between;
  align-items: center;
}

.chat-window {
  flex: 1;
  overflow-y: auto;
  padding: 12px;
  background: #f8fafc;
}

.chat-message {
  margin-bottom: 10px;
  max-width: 80%;
}

.chat-message.admin {
  margin-left: auto;
  text-align: right;
}

.chat-message-body {
  padding: 8px 10px;
  border-radius: 8px;
  background: #fff;
  display: inline-block;
}

.chat-message.admin .chat-message-body {
  background: #2563eb;
  color: #fff;
}

.chat-message-meta {
  font-size: 11px;
  color: #666;
  margin-bottom: 2px;
}

/* ===== Input ===== */
.chat-input-area {
  border-top: 1px solid #ddd;
  padding: 8px;
  display: flex;
  gap: 6px;
}

.chat-input-area textarea {
  flex: 1;
  resize: none;
  height: 44px;
}

.chat-input-area button {
  padding: 0 14px;
}

/* =========================
   Mobile
========================= */
@media (max-width: 768px) {

  .admin-container {
    display: block;
  }

  .ticket-list {
    width: 100%;
  }

  .chat-panel {
    position: fixed;
    inset: 0;
    background: #fff;
    z-index: 2000;
    display: none;
  }

  .chat-panel.active {
    display: flex;
  }

  .chat-header {
    background: #111;
    color: #fff;
  }

  .chat-header button {
    background: none;
    border: none;
    color: #fff;
    font-size: 14px;
  }
}
</style>
</head>

<body>

<div class="admin-container">

  <!-- ======================
       Ticket List
  ======================= -->
  <div class="ticket-list">
    <table class="table">
      <thead>
        <tr>
          <th>ID</th>
          <th>更新</th>
          <th>件名</th>
          <th>表示</th>
        </tr>
      </thead>
      <tbody id="ticket-table-body"></tbody>
    </table>
  </div>

  <!-- ======================
       Chat Panel
  ======================= -->
  <div class="chat-panel" id="chat-panel">
    <div class="chat-header">
      <span id="chat-title">チャット</span>
      <button onclick="closeChatMobile()">戻る</button>
    </div>

    <div class="chat-window" id="chat-window"></div>

    <div class="chat-input-area" id="chat-input-area">
      <textarea id="chat-input" placeholder="メッセージ入力"></textarea>
      <button id="btn-send">送信</button>
    </div>
  </div>

</div>

<div class="toast" id="toast"></div>

<script>
const API_BASE = "https://api.exchange-template.com";
let allTickets = [];
let currentTicketId = null;

/* =========================
   Utility
========================= */
function showToast(msg) {
  const t = document.getElementById("toast");
  t.textContent = msg;
  t.classList.add("show");
  setTimeout(() => t.classList.remove("show"), 2000);
}

function fmtDate(s) {
  return new Date(s).toLocaleString("ja-JP",{hour12:false});
}

/* =========================
   API
========================= */
async function apiGet(path) {
  const res = await fetch(API_BASE + path,{credentials:"include"});
  if (!res.ok) throw new Error();
  return res.json();
}

async function apiPost(path,body) {
  const res = await fetch(API_BASE + path,{
    method:"POST",
    credentials:"include",
    headers:{"Content-Type":"application/json"},
    body:JSON.stringify(body)
  });
  if (!res.ok) throw new Error();
}

/* =========================
   Tickets
========================= */
async function loadTickets() {
  allTickets = await apiGet("/tickets/admin/all");
  const tbody = document.getElementById("ticket-table-body");
  tbody.innerHTML = "";

  allTickets.forEach(t=>{
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td>${t.id}</td>
      <td>${fmtDate(t.updatedAt)}</td>
      <td>${t.title}</td>
      <td><button class="btn-xs" onclick="openChat(${t.id})">表示</button></td>
    `;
    tbody.appendChild(tr);
  });
}

/* =========================
   Chat
========================= */
async function openChat(ticketId) {
  currentTicketId = ticketId;
  const panel = document.getElementById("chat-panel");
  panel.classList.add("active");

  const msgs = await apiGet(`/tickets/${ticketId}/messages`);
  const ticket = allTickets.find(t=>t.id===ticketId);

  document.getElementById("chat-title").textContent =
    `#${ticketId} ${ticket.title}`;

  const win = document.getElementById("chat-window");
  win.innerHTML = "";

  msgs.forEach(m=>{
    const div = document.createElement("div");
    div.className = "chat-message " + (m.sender==="ADMIN"?"admin":"user");
    div.innerHTML = `
      <div class="chat-message-meta">${m.sender} / ${fmtDate(m.createdAt)}</div>
      <div class="chat-message-body">${m.message}</div>
    `;
    win.appendChild(div);
  });

  win.scrollTop = win.scrollHeight;

  const inputArea = document.getElementById("chat-input-area");
  inputArea.style.display = ticket.status==="CLOSED" ? "none" : "flex";
}

function closeChatMobile() {
  document.getElementById("chat-panel").classList.remove("active");
}

/* =========================
   Send
========================= */
document.getElementById("btn-send").addEventListener("click", async()=>{
  const input = document.getElementById("chat-input");
  const msg = input.value.trim();
  if (!msg || !currentTicketId) return;

  await apiPost(`/tickets/admin/${currentTicketId}/reply`,{message:msg});
  input.value = "";
  openChat(currentTicketId);
});

/* Init */
loadTickets();
</script>

<script src="/admin/assets/js/admin-auth.js"></script>
<script src="/admin/assets/js/header-admin.js"></script>

</body>
</html>
