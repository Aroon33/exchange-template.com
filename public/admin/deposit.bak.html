<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>CryptoX Admin - å…¥é‡‘ç”³è«‹ç®¡ç†</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <!-- CSS -->
  <link rel="stylesheet" href="../assets/css/style.css">
  <link rel="stylesheet" href="../assets/css/admin.css">

   <style>
/* ===== Mobile Modal ===== */
@media (max-width: 768px) {

  .table td.actions,
  .table th.actions {
    display: none;
  }

  .modal {
    display: none;
    position: fixed;
    inset: 0;
    background: rgba(0,0,0,0.5);
    z-index: 999;
  }

  .modal-content {
    background: #fff;
    margin: 10% auto;
    width: 92%;
    border-radius: 8px;
    overflow: hidden;
  }

  .modal-header,
  .modal-footer {
    padding: 12px;
    border-bottom: 1px solid #eee;
  }

  .modal-footer {
    border-top: 1px solid #eee;
    display: flex;
    gap: 8px;
  }

  .modal-body {
    padding: 12px;
    font-size: 14px;
  }

  .modal-close {
    background: none;
    border: none;
    font-size: 20px;
  }
}
/* ===== Deposit Responsive ===== */
@media (max-width: 768px) {

  .thead-pc {
    display: none;
  }

  .thead-sp {
    display: table-header-group;
  }

  .table td.actions,
  .table th.actions {
    display: none;
  }

  /* ã‚¹ãƒãƒ›è¡Œã‚’ã‚«ãƒ¼ãƒ‰é¢¨ã« */
  .deposit-row td {
    padding: 10px;
    font-size: 14px;
  }
}
@media (max-width: 768px) {
  .pc-only {
    display: none;
  }
}


/* PCã§ã¯SPãƒ˜ãƒƒãƒ€ãƒ¼éè¡¨ç¤º */
@media (min-width: 769px) {
  .thead-sp {
    display: none;
  }
}


</style>

</head>
<body>

<!-- SIDEBAR -->
<aside class="sidebar">
  <div class="sidebar-title">ãƒ¡ãƒ‹ãƒ¥ãƒ¼</div>
  <ul class="nav-list">
    <li class="nav-item"><a href="index.html" class="nav-link">ğŸ  ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰</a></li>
    <li class="nav-item"><a href="tickets.html" class="nav-link">ğŸ’¬ å•ã„åˆã‚ã›ç®¡ç†</a></li>
    <li class="nav-item"><a href="users.html" class="nav-link">ğŸ‘¥ ãƒ¦ãƒ¼ã‚¶ãƒ¼ä¸€è¦§</a></li>
    <li class="nav-item"><a href="trades.html" class="nav-link">ğŸ“Š å–å¼•çŠ¶æ³</a></li>
    <li class="nav-item"><a href="kyc.html" class="nav-link">ğŸ“‹ KYCçŠ¶æ³</a></li>
    <li class="nav-item"><a href="deposit.html" class="nav-link">â• å…¥é‡‘ç”³è«‹</a></li>
    <li class="nav-item"><a href="withdraw.html" class="nav-link">â– å‡ºé‡‘ç”³è«‹</a></li>
    <li class="nav-item"><a href="group.html" class="nav-link">ğŸ§© ã‚°ãƒ«ãƒ¼ãƒ—ç®¡ç†</a></li>
    <li class="nav-item"><a href="settings.html" class="nav-link">âš™ï¸ ã‚·ã‚¹ãƒ†ãƒ è¨­å®š</a></li>
    <li class="nav-item"><a href="system-positions.html" class="nav-link">ğŸ“ˆ ã‚·ã‚¹ãƒ†ãƒ ãƒã‚¸ã‚·ãƒ§ãƒ³</a></li>
    <li class="nav-item"><a href="system-history.html" class="nav-link active">ğŸ“œ ã‚·ã‚¹ãƒ†ãƒ å±¥æ­´</a></li>
    <li class="nav-item"><a href="deposit-bank-accounts.html" class="nav-link active">ğŸ“œ éŠ€è¡Œç®¡ç†</a></li>
    <li class="nav-item"><a href="deposit-bank-accounts-edit.html" class="nav-link active">ğŸ“œ å£åº§ç™»éŒ²</a></li>
    <li class="nav-item"><a href="deposit-crypto-address-form.html" class="nav-link active">ğŸ“œ ã‚¢ãƒ‰ãƒ¬ã‚¹ç™»éŒ²</a></li>
  </ul>
</aside>
<!-- HEADER -->
<header class="admin-header">
  <div class="admin-header-left">
    <div class="admin-logo-badge">AX</div>
    <div>
      <div class="admin-logo-text">Admin Console</div>
      <div class="admin-logo-sub">å…¥é‡‘ç”³è«‹ç®¡ç†</div>
    </div>
  </div>
  <div class="admin-header-right">
    <span id="admin-user-label">ç®¡ç†è€…</span>
    <!-- â–¼ è¿½åŠ ï¼šã‚µã‚¤ãƒ‰ãƒãƒ¼ãƒˆã‚°ãƒ« -->
    <button class="sidebar-toggle" onclick="toggleSidebar()">â˜°</button> 
   <button class="btn btn-outline btn-sm" onclick="doLogout()">ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ</button>
  </div>
</header>

<!-- overlay -->
<div class="sidebar-overlay" onclick="closeSidebar()"></div>
<main class="admin-main">
  <div class="admin-main-inner">

    <div class="page-title">å…¥é‡‘ç”³è«‹ä¸€è¦§</div>

    <div style="margin:12px 0;">
      <select id="status-filter" class="btn-sm">
  <option value="ALL">ã™ã¹ã¦</option>
  <option value="PENDING">ç”³è«‹ä¸­</option>
  <option value="CONFIRMING">ç¢ºèªä¸­</option>
  <option value="COMPLETED">å®Œäº†</option>
  <option value="CANCELED">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</option>
</select>
      <button class="btn-sm" id="reload-btn">å†èª­ã¿è¾¼ã¿</button>
    </div>

    <div class="card">
      <table class="table" style="width:100%; font-size:13px;">
        <!-- PCç”¨ãƒ˜ãƒƒãƒ€ãƒ¼ -->
<thead class="thead-pc">
  <tr>
    <th>ID</th>
    <th>ç”³è«‹æ—¥æ™‚</th>
    <th>åå‰</th>
    <th>ç¨®åˆ¥</th>
    <th>é€šè²¨</th>
    <th>ç”³è«‹é‡‘é¡</th>
    <th>å…¥é‡‘é¡</th>
    <th>æ›´æ–°æ—¥æ™‚</th>
    <th>ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹</th>
    <th class="actions">æ“ä½œ</th>
  </tr>
</thead>

<!-- ã‚¹ãƒãƒ›ç”¨ãƒ˜ãƒƒãƒ€ãƒ¼ -->
<thead class="thead-sp">
  <tr>
    <th>å…¥é‡‘</th>
  </tr>
</thead>

        <tbody id="deposit-table-body">
          <tr>
  <td colspan="100%" style="text-align:center;">èª­ã¿è¾¼ã¿ä¸­...</td>
</tr>

        </tbody>
      </table>
    </div>

  </div>
</main>

<!-- =========================
   Deposit Detail Modal (Mobile)
========================= -->
<div id="deposit-modal" class="modal">
  <div class="modal-content">
    <div class="modal-header">
      <span id="modal-title">å…¥é‡‘è©³ç´°</span>
      <button class="modal-close" onclick="closeDepositModal()">Ã—</button>
    </div>

    <div class="modal-body" id="modal-body">
      <!-- JSã§å‹•çš„ã«åŸ‹ã‚ã‚‹ -->
    </div>

    <div class="modal-footer" id="modal-footer">
      <!-- æ“ä½œãƒœã‚¿ãƒ³ -->
    </div>
  </div>
</div>


<div class="toast" id="toast"></div>

<script>
const API_BASE = "https://api.exchange-template.com";

/* =========================
   Toast
========================= */
function showToast(msg) {
  const t = document.getElementById("toast");
  t.textContent = msg;
  t.classList.add("show");
  setTimeout(() => t.classList.remove("show"), 2000);
}

/* =========================
   Formatters
========================= */
function formatDate(v) {
  return v ? new Date(v).toLocaleString("ja-JP", { hour12:false }) : "-";
}

/**
 * é‡‘é¡ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ
 * type = "JPY" | "CRYPTO"
 */
function formatAmount(value, type = "JPY") {
  const num = Number(value);
  if (isNaN(num)) return "-";

  if (type === "CRYPTO") {
    // æš—å·è³‡ç”£ï¼šå°æ•°ç‚¹ä»¥ä¸‹4æ¡
    return num.toFixed(4);
  }

  // æ—¥æœ¬å††ï¼šã‚«ãƒ³ãƒåŒºåˆ‡ã‚Šãƒ»å°æ•°ãªã—
  return Math.floor(num).toLocaleString("ja-JP");
}

/* =========================
   API wrappers
========================= */
async function apiGet(path) {
  const res = await fetch(API_BASE + path, { credentials:"include" });
  if (!res.ok) throw new Error();
  return res.json();
}

async function apiPost(path, body) {
  const res = await fetch(API_BASE + path, {
    method:"POST",
    credentials:"include",
    headers:{ "Content-Type":"application/json" },
    body: JSON.stringify(body),
  });
  if (!res.ok) throw new Error();
}

/* =========================
   Actions
========================= */
async function approveDeposit(id) {
  try {
    await apiPost("/deposit/approve", { id });
    showToast("æ‰¿èªã—ã¾ã—ãŸ");
    loadDeposits();
  } catch {
    showToast("æ‰¿èªã«å¤±æ•—ã—ã¾ã—ãŸ");
  }
}

async function sendDepositAddress(id) {
  // â˜… ã“ã“ã«è¿½åŠ ã™ã‚‹ï¼ˆ1è¡Œï¼‰
  if (!confirm("å…¥é‡‘ã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’é€ä¿¡ã—ã¾ã™ã‹ï¼Ÿ")) return;

  try {
    await apiPost("/deposit/assign-crypto", { id });
    showToast("å…¥é‡‘ã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’é€ä¿¡ã—ã¾ã—ãŸ");
    loadDeposits();
  } catch {
    showToast("ã‚¢ãƒ‰ãƒ¬ã‚¹é€ä¿¡ã«å¤±æ•—ã—ã¾ã—ãŸ");
  }
}



function openChat(userId) {
  if (!userId) {
    showToast("ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ãŒã‚ã‚Šã¾ã›ã‚“");
    return;
  }
  location.href = `tickets.html?user=${userId}`;
}

/* =========================
   Render table
========================= */
function openDepositModal(t) {
  const modal = document.getElementById("deposit-modal");
  const body = document.getElementById("modal-body");
  const footer = document.getElementById("modal-footer");

  body.innerHTML = `
    <div><b>IDï¼š</b>${t.id}</div>
    <div><b>ãƒ¦ãƒ¼ã‚¶ãƒ¼ï¼š</b>${t.user?.name ?? "-"}</div>
    <div><b>é€šè²¨ï¼š</b>${t.currency}</div>
    <div><b>ç”³è«‹é‡‘é¡ï¼š</b>${t.amount}</div>
    <div><b>å…¥é‡‘é¡ï¼š</b>${t.cryptoAmount ?? t.amount}</div>
    <div><b>ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ï¼š</b>${t.status}</div>
    <div><b>ç”³è«‹æ—¥æ™‚ï¼š</b>${formatDate(t.createdAt)}</div>
  `;

  footer.innerHTML = `
    ${
      t.status === "PENDING" && t.method === "CRYPTO"
        ? `<button class="btn btn-primary"
                   onclick="sendDepositAddress(${t.id})">
             ã‚¢ãƒ‰ãƒ¬ã‚¹é€ä¿¡
           </button>`
        : ""
    }

    ${
      t.status === "CONFIRMING"
        ? `<button class="btn btn-success"
                   onclick="approveDeposit(${t.id})">
             ç€é‡‘ç¢ºèª
           </button>`
        : ""
    }

    <button class="btn btn-warning"
            onclick="openChat(${t.user?.id})">
      ãƒãƒ£ãƒƒãƒˆ
    </button>
  `;

  modal.style.display = "block";
}



function closeDepositModal() {
  document.getElementById("deposit-modal").style.display = "none";
}


function renderTable(list) {
  const tbody = document.getElementById("deposit-table-body");
  tbody.innerHTML = "";

  if (!list.length) {
    tbody.innerHTML =
      '<tr><td colspan="10" style="text-align:center;">ç”³è«‹ãªã—</td></tr>';
    return;
  }

  list.forEach(t => {
    // CRYPTO åˆ¤å®šï¼ˆæœ€ã‚‚å®‰å…¨ï¼‰
    const isCrypto =
      t.cryptoAmount !== null &&
      !isNaN(Number(t.cryptoAmount)) &&
      Number(t.cryptoAmount) > 0;

    const methodLabel = isCrypto ? "æš—å·è³‡ç”£" : "æ—¥æœ¬å††";
    const currency = isCrypto ? t.currency : "JPY";

    // ç”³è«‹é‡‘é¡ï¼ˆå¸¸ã«JPYï¼‰
    const requestAmount =
      `${formatAmount(t.amount, "JPY")} JPY`;

    // å…¥é‡‘é¡ï¼ˆJPY or CRYPTOï¼‰
    const depositAmount = isCrypto
      ? `${formatAmount(t.cryptoAmount, "CRYPTO")} ${currency}`
      : `${formatAmount(t.amount, "JPY")} JPY`;

    const statusJP =
  t.status === "PENDING"     ? "ç”³è«‹ä¸­" :
  t.status === "CONFIRMING"  ? "ç¢ºèªä¸­" :
  t.status === "COMPLETED"   ? "å®Œäº†" :
  "ã‚­ãƒ£ãƒ³ã‚»ãƒ«";


    tbody.insertAdjacentHTML("beforeend", `
<tr class="deposit-row"
    onclick="
      if (window.innerWidth <= 900) {
        openDepositModal(${JSON.stringify(t)})
      }
    "
    style="cursor:pointer;">

  <!-- PC / SP å…±é€šã‚»ãƒ«ï¼ˆSPã§ã¯1åˆ—ã¨ã—ã¦è¦‹ãˆã‚‹ï¼‰ -->
  <td>
    <div><b>ID:</b> ${t.id}</div>
    <div><b>ãƒ¦ãƒ¼ã‚¶ãƒ¼:</b> ${t.user?.name ?? "-"}</div>
    <div><b>é€šè²¨:</b> ${currency}</div>
    <div><b>é‡‘é¡:</b> ${depositAmount}</div>
    <div><b>çŠ¶æ…‹:</b> ${statusJP}</div>
    <div class="muted">${formatDate(t.createdAt)}</div>
  </td>

  <!-- PCå°‚ç”¨ã‚»ãƒ«ç¾¤ -->
  <td class="pc-only">${formatDate(t.createdAt)}</td>
  <td class="pc-only">${t.user?.name ?? "-"}</td>
  <td class="pc-only">${methodLabel}</td>
  <td class="pc-only">${currency}</td>
  <td class="pc-only">${requestAmount}</td>
  <td class="pc-only">${depositAmount}</td>
  <td class="pc-only">${formatDate(t.updatedAt)}</td>
  <td class="pc-only">${statusJP}</td>

  <!-- PCæ“ä½œåˆ— -->
  <td class="actions pc-only">
    ${
      t.status === "PENDING" &&
      t.method === "CRYPTO"
        ? `<button class="btn-xs btn-primary"
                   onclick="event.stopPropagation(); sendDepositAddress(${t.id})">
             ã‚¢ãƒ‰ãƒ¬ã‚¹é€ä¿¡
           </button>`
        : ""
    }

    ${
      t.status === "CONFIRMING"
        ? `<button class="btn-xs btn-xs-primary"
                   onclick="event.stopPropagation(); approveDeposit(${t.id})">
             ç€é‡‘ç¢ºèª
           </button>`
        : ""
    }

    <button class="btn-xs btn-warning"
            onclick="event.stopPropagation(); openChat(${t.user?.id})">
      ãƒãƒ£ãƒƒãƒˆ
    </button>
  </td>
</tr>
`);


  });
}

/* =========================
   Load + Filter
========================= */
async function loadDeposits() {
  try {
    const status = document.getElementById("status-filter").value;

    let list = await apiGet("/deposit/all");

    // é˜²å¾¡ãƒ­ã‚¸ãƒƒã‚¯
    if (status === "PENDING") {
      list = await apiGet("/deposit/pending");
    } else if (status !== "ALL") {
      list = list.filter(
        t => String(t.status).toUpperCase() === status
      );
    }

    renderTable(list);
  } catch {
    showToast("å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ");
  }
}

/* =========================
   Init
========================= */
document.getElementById("status-filter").addEventListener("change", loadDeposits);
document.getElementById("reload-btn").addEventListener("click", loadDeposits);
loadDeposits();
</script>



</body>
</html>

