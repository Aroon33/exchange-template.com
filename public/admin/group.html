<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>CryptoX Admin - ã‚°ãƒ«ãƒ¼ãƒ—ç®¡ç†</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <link rel="stylesheet" href="../assets/css/style.css">
  <link rel="stylesheet" href="../assets/css/admin.css">

  <style>
    .group-table th, .group-table td {
      padding: 8px 6px;
      font-size: 13px;
    }
    .copy-btn {
      cursor: pointer;
      color: #1652f0;
      font-size: 11px;
      margin-left: 4px;
    }

    /* ãƒ¢ãƒ¼ãƒ€ãƒ« */
    .modal-overlay {
      display: none;
      position: fixed;
      top:0; left:0;
      width:100%; height:100%;
      background:rgba(0,0,0,0.48);
      justify-content:center;
      align-items:center;
      z-index:999;
    }
    .modal {
      background:#fff;
      padding:20px;
      border-radius:10px;
      width:400px;
    }
    .modal-row { 
      margin-bottom:10px; 
    }
    .modal-row label { 
      font-size:12px; 
    }
    .modal-row input {
      width:100%; padding:7px 8px;
      border:1px solid #ccc;
      border-radius:6px;
    }
    .modal-actions { 
      text-align:right;
      margin-top:12px; 
    }
  </style>
</head>

<body>

<!-- SIDEBAR -->
<aside class="sidebar">
  <div class="sidebar-title">ãƒ¡ãƒ‹ãƒ¥ãƒ¼</div>
  <ul class="nav-list">
    <li class="nav-item"><a href="index.html" class="nav-link">ğŸ  ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰</a></li>
    <li class="nav-item"><a href="tickets.html" class="nav-link">ğŸ’¬ å•ã„åˆã‚ã›ç®¡ç†</a></li>
    <li class="nav-item"><a href="users.html" class="nav-link">ğŸ‘¥ ãƒ¦ãƒ¼ã‚¶ãƒ¼ä¸€è¦§</a></li>
    <li class="nav-item"><a href="trades.html" class="nav-link">ğŸ“Š å–å¼•çŠ¶æ³</a></li>
    <li class="nav-item"><a href="kyc.html" class="nav-link">ğŸ“‹ KYCçŠ¶æ³</a></li>
    <li class="nav-item"><a href="deposit.html" class="nav-link">â• å…¥é‡‘ç”³è«‹</a></li>
    <li class="nav-item"><a href="withdraw.html" class="nav-link">â– å‡ºé‡‘ç”³è«‹</a></li>
    <li class="nav-item"><a href="group.html" class="nav-link">ğŸ§© ã‚°ãƒ«ãƒ¼ãƒ—ç®¡ç†</a></li>
    <li class="nav-item"><a href="settings.html" class="nav-link">âš™ï¸ ã‚·ã‚¹ãƒ†ãƒ è¨­å®š</a></li>
    <li class="nav-item"><a href="system-positions.html" class="nav-link">ğŸ“ˆ ã‚·ã‚¹ãƒ†ãƒ ãƒã‚¸ã‚·ãƒ§ãƒ³</a></li>
    <li class="nav-item"><a href="system-history.html" class="nav-link active">ğŸ“œ ã‚·ã‚¹ãƒ†ãƒ å±¥æ­´</a></li>
    <li class="nav-item"><a href="deposit-bank-accounts.html" class="nav-link active">ğŸ“œ éŠ€è¡Œç®¡ç†</a></li>
    <li class="nav-item"><a href="deposit-bank-accounts-edit.html" class="nav-link active">ğŸ“œ å£åº§ç™»éŒ²</a></li>
    <li class="nav-item"><a href="deposit-crypto-address-form.html" class="nav-link active">ğŸ“œ ã‚¢ãƒ‰ãƒ¬ã‚¹ç™»éŒ²</a></li>
  </ul>
</aside>

<header class="admin-header">
  <div class="admin-header-left">
    <div class="admin-logo-badge">AX</div>
    <div>
      <div class="admin-logo-text">Admin Console</div>
      <div class="admin-logo-sub">ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰</div>
    </div>
  </div>
  <div class="admin-header-right">

<!-- â–¼ è¿½åŠ ï¼šã‚µã‚¤ãƒ‰ãƒãƒ¼ãƒˆã‚°ãƒ« -->
    <button class="sidebar-toggle" onclick="toggleSidebar()">â˜°</button> 
   <button class="btn btn-outline btn-sm" onclick="doLogout()">ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ</button>
  </div>
</header>

<!-- overlay -->
<div class="sidebar-overlay" onclick="closeSidebar()"></div>
<main class="admin-main">
  <div class="admin-main-inner">

    <div class="page-title">ã‚°ãƒ«ãƒ¼ãƒ—ç®¡ç†</div>

    <!-- â–¼ æ–°è¦ä½œæˆ -->
    <section class="card" style="margin-bottom:20px;">
      <h2 class="card-title-small">ã‚°ãƒ«ãƒ¼ãƒ—æ–°è¦ä½œæˆ</h2>

      <div class="form-row">
        <label>ã‚°ãƒ«ãƒ¼ãƒ—å</label>
        <input type="text" id="new-group-name" placeholder="ä¾‹ï¼švip-team" />
      </div>

      <button class="btn-xs btn-xs-primary" id="btn-create">ä½œæˆ</button>

      <p id="msg-create" class="muted" style="margin-top:6px;"></p>
    </section>

    <!-- â–¼ ã‚°ãƒ«ãƒ¼ãƒ—ä¸€è¦§ -->
    <section class="table-card">
      <div class="table-header-row">
        <div>
          <div class="table-title">ã‚°ãƒ«ãƒ¼ãƒ—ä¸€è¦§</div>
          <div class="table-sub" id="group-count">0ä»¶</div>
        </div>
      </div>

      <table class="table group-table">
        <thead>
          <tr>
            <th>ID</th>
            <th>ã‚°ãƒ«ãƒ¼ãƒ—å</th>
            <th>ã‚³ãƒ¼ãƒ‰</th>
            <th>æ‹›å¾…ãƒªãƒ³ã‚¯</th>
            <th>äººæ•°</th>
            <th>æ“ä½œ</th>
          </tr>
        </thead>
        <tbody id="group-body">
          <tr><td colspan="6" style="text-align:center;">èª­ã¿è¾¼ã¿ä¸­...</td></tr>
        </tbody>
      </table>
    </section>

    <!-- â–¼ çµ±è¨ˆè¡¨ç¤ºã™ã‚‹ã‚°ãƒ«ãƒ¼ãƒ—ã‚’é¸æŠ -->
<section class="card" style="margin-top:25px;">
  <h2 class="card-title-small">çµ±è¨ˆã‚’è¡¨ç¤ºã™ã‚‹ã‚°ãƒ«ãƒ¼ãƒ—ã‚’é¸æŠ</h2>

  <div class="form-row">
    <label>ã‚°ãƒ«ãƒ¼ãƒ—ã‚’é¸æŠã—ã¦ãã ã•ã„</label>
    <select id="stats-group-select">
      <option value="">é¸æŠã—ã¦ãã ã•ã„</option>
    </select>
  </div>
</section>

    <!-- â–¼ ã‚°ãƒ«ãƒ¼ãƒ—ç§»å‹• UI -->
<section class="card" style="margin-top:25px;">
  <h2 class="card-title-small">ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’ã‚°ãƒ«ãƒ¼ãƒ—ã¸ç§»å‹•</h2>

  <div class="form-row">
    <label>ãƒ¦ãƒ¼ã‚¶ãƒ¼æ¤œç´¢ï¼ˆID / ãƒ¡ãƒ¼ãƒ« / åå‰ï¼‰</label>
    <input id="move-search" type="text" placeholder="ä¾‹ï¼š8 / test@example.com / å±±ç”°" />
  </div>

  <button class="btn-xs" id="btn-search-user">æ¤œç´¢</button>

  <div id="move-user-result" class="muted" style="margin-top:10px;">
    æ¤œç´¢çµæœãŒã“ã“ã«è¡¨ç¤ºã•ã‚Œã¾ã™
  </div>

  <div class="form-row" style="margin-top:14px;">
    <label>ç§»å‹•å…ˆã‚°ãƒ«ãƒ¼ãƒ—</label>
    <select id="move-group-select">
      <option value="">é¸æŠã—ã¦ãã ã•ã„</option>
    </select>
  </div>

  <button class="btn-xs btn-xs-primary" id="btn-move-group" style="margin-top:10px;">
    ã‚°ãƒ«ãƒ¼ãƒ—ã¸ç§»å‹•
  </button>

  <p id="move-message" style="margin-top:8px;" class="muted"></p>
</section>

<!-- â–¼ ã‚°ãƒ«ãƒ¼ãƒ—çµ±è¨ˆï¼šè‡ªå‹•é›†è¨ˆ -->
<section class="card" style="margin-top:25px;">
  <h2 class="card-title-small">ã‚°ãƒ«ãƒ¼ãƒ—çµ±è¨ˆ</h2>

  <p>ãƒ¦ãƒ¼ã‚¶ãƒ¼æ•°ï¼š<b id="stat-user-count">-</b></p>
  <p>åˆè¨ˆæ®‹é«˜ï¼š<b id="stat-total-balance">-</b></p>
  <p>ãƒã‚¸ã‚·ãƒ§ãƒ³æ•°ï¼š<b id="stat-positions-count">-</b></p>

  <h3 style="margin-top:15px;">æ‰€å±ãƒ¦ãƒ¼ã‚¶ãƒ¼ä¸€è¦§</h3>
  <table class="table group-table">
    <thead>
      <tr>
        <th>ID</th>
        <th>åå‰</th>
        <th>æ®‹é«˜ (JPY)</th>
        <th>ãƒã‚¸ã‚·ãƒ§ãƒ³æ•°</th>
      </tr>
    </thead>
    <tbody id="group-users-body">
      <tr><td colspan="4" style="text-align:center;">ã‚°ãƒ«ãƒ¼ãƒ—ã‚’é¸æŠã—ã¦ãã ã•ã„</td></tr>
    </tbody>
  </table>
</section>

  </div>
</main>

<!-- â–¼ ç·¨é›†ãƒ¢ãƒ¼ãƒ€ãƒ« -->
<div class="modal-overlay" id="modal">
  <div class="modal">
    <div class="modal-header">ã‚°ãƒ«ãƒ¼ãƒ—ç·¨é›†</div>

    <div class="modal-row">
      <label>ã‚°ãƒ«ãƒ¼ãƒ—å</label>
      <input id="m-name" />
    </div>

    <div class="modal-row">
      <label>ã‚³ãƒ¼ãƒ‰ï¼ˆè‹±æ•°å­—ã®ã¿ï¼‰</label>
      <input id="m-code" />
    </div>

    <div class="modal-actions">
      <button id="m-cancel">é–‰ã˜ã‚‹</button>
      <button class="btn-xs btn-xs-primary" id="m-save">ä¿å­˜</button>
    </div>
  </div>
</div>

<script>
const API = "https://api.exchange-template.com";

const tbody = document.getElementById("group-body");
const countEl = document.getElementById("group-count");

let editId = null;

/* -----------------------------
      API UTIL
----------------------------- */
async function apiGet(p){
  const r = await fetch(API + p, { credentials:"include" });
  const t = await r.text();
  if(!r.ok) throw new Error(t);
  return JSON.parse(t);
}
async function apiPost(p, body){
  const r = await fetch(API + p, {
    method:"POST",
    credentials:"include",
    headers:{ "Content-Type":"application/json" },
    body: JSON.stringify(body),
  });
  const t = await r.text();
  if(!r.ok) throw new Error(t);
  return JSON.parse(t);
}
async function apiPatch(p, body){
  const r = await fetch(API + p, {
    method:"PATCH",
    credentials:"include",
    headers:{ "Content-Type":"application/json" },
    body: JSON.stringify(body),
  });
  const t = await r.text();
  if(!r.ok) throw new Error(t);
  return JSON.parse(t);
}
async function apiDelete(p){
  const r = await fetch(API + p, {
    method:"DELETE",
    credentials:"include",
  });
  const t = await r.text();
  if(!r.ok) throw new Error(t);
  return JSON.parse(t);
}


/* -----------------------------
      â–¼ ã‚°ãƒ«ãƒ¼ãƒ—ä¸€è¦§è¡¨ç¤º
----------------------------- */
async function loadGroups(){
  const groups = await apiGet("/admin/groups");

  tbody.innerHTML="";
  groups.forEach(g=>{
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td>${g.id}</td>
      <td>${g.name}</td>
      <td>${g.code}</td>
      <td>
        <span>${g.inviteLink}</span>
        <span class="copy-btn" data-copy="${g.inviteLink}">ã‚³ãƒ”ãƒ¼</span>
      </td>
      <td>${g.userCount}</td>
      <td>
        <button class="btn-xs" data-edit="${g.id}" data-name="${g.name}" data-code="${g.code}">ç·¨é›†</button>
        <button class="btn-xs btn-danger" data-del="${g.id}">å‰Šé™¤</button>
      </td>
    `;
    tbody.appendChild(tr);
  });

  countEl.textContent = groups.length + "ä»¶";

  /* ã‚³ãƒ”ãƒ¼ */
  document.querySelectorAll("[data-copy]").forEach(btn=>{
    btn.onclick =()=>{
      navigator.clipboard.writeText(btn.dataset.copy);
      alert("ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸï¼");
    };
  });

  /* ç·¨é›† */
  document.querySelectorAll("[data-edit]").forEach(btn=>{
    btn.onclick=()=>{
      editId = btn.dataset.edit;
      document.getElementById("m-name").value = btn.dataset.name;
      document.getElementById("m-code").value = btn.dataset.code;

      document.getElementById("modal").style.display="flex";
    };
  });

  /* å‰Šé™¤ */
  document.querySelectorAll("[data-del]").forEach(btn=>{
    btn.onclick = async () => {
      if (!confirm("å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ\næ‰€å±ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¯æœªæ‰€å±ï¼ˆgroupId:nullï¼‰ã«ãªã‚Šã¾ã™ã€‚")) return;

      await apiDelete(`/admin/groups/${btn.dataset.del}`);
      loadGroups();
      loadGroupOptionsStats();
      loadGroupOptions();
    };
  });

  /* çµ±è¨ˆç”¨ã‚»ãƒ¬ã‚¯ãƒˆã‚‚æ›´æ–° */
  loadGroupOptionsStats();
}


/* -----------------------------
   â–¼ çµ±è¨ˆç”¨ã‚°ãƒ«ãƒ¼ãƒ—é¸æŠã®ãƒªã‚¹ãƒˆã‚’ä½œæˆ
----------------------------- */
async function loadGroupOptionsStats(){
  const groups = await apiGet("/admin/groups");
  const sel = document.getElementById("stats-group-select");
  sel.innerHTML = `<option value="">é¸æŠã—ã¦ãã ã•ã„</option>`;

  groups.forEach(g=>{
    sel.innerHTML += `<option value="${g.id}">${g.name}ï¼ˆID:${g.id}ï¼‰</option>`;
  });
}


/* -----------------------------
   â–¼ ç§»å‹•å…ˆã‚°ãƒ«ãƒ¼ãƒ—ã®ãƒªã‚¹ãƒˆä½œæˆ
----------------------------- */
async function loadGroupOptions() {
  const groups = await apiGet("/admin/groups");
  const sel = document.getElementById("move-group-select");
  sel.innerHTML = '<option value="">é¸æŠã—ã¦ãã ã•ã„</option>';

  groups.forEach(g=>{
    sel.innerHTML += `<option value="${g.id}">${g.name}ï¼ˆ${g.code}ï¼‰</option>`;
  });
}


/* -----------------------------
   â–¼ ãƒ¦ãƒ¼ã‚¶ãƒ¼æ¤œç´¢
----------------------------- */
document.getElementById("btn-search-user").onclick = async () => {
  const q = document.getElementById("move-search").value.trim();
  const result = document.getElementById("move-user-result");

  if (!q) {
    result.textContent = "æ¤œç´¢ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„";
    result.style.color = "red";
    return;
  }

  try {
    const users = await apiGet("/admin/users");

    const user = users.find(u =>
      String(u.id) === q ||
      (u.email && u.email.includes(q)) ||
      (u.name && u.name.includes(q))
    );

    if (!user) {
      result.textContent = "è©²å½“ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“";
      result.style.color = "red";
      return;
    }

    result.innerHTML = `
      <b>æ¤œç´¢çµæœ:</b><br>
      ãƒ¦ãƒ¼ã‚¶ãƒ¼ID: ${user.id}<br>
      åå‰: ${user.name}<br>
      ãƒ¡ãƒ¼ãƒ«: ${user.email}<br>
      ç¾åœ¨ã®ã‚°ãƒ«ãƒ¼ãƒ—: ${user.groupId ?? "ãªã—"}
    `;
    result.style.color = "#333";

    result.dataset.userId = user.id;

  } catch (e) {
    result.textContent = "APIã‚¨ãƒ©ãƒ¼ï¼š" + e;
    result.style.color = "red";
  }
};


/* -----------------------------
   â–¼ ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’ã‚°ãƒ«ãƒ¼ãƒ—ã¸ç§»å‹•
----------------------------- */
document.getElementById("btn-move-group").onclick = async () => {
  const msg = document.getElementById("move-message");
  const userId = document.getElementById("move-user-result").dataset.userId;
  const groupId = document.getElementById("move-group-select").value;

  if (!userId) {
    msg.textContent = "å…ˆã«ãƒ¦ãƒ¼ã‚¶ãƒ¼æ¤œç´¢ã—ã¦ãã ã•ã„ã€‚";
    msg.style.color = "red";
    return;
  }

  if (!groupId) {
    msg.textContent = "ç§»å‹•å…ˆã‚°ãƒ«ãƒ¼ãƒ—ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚";
    msg.style.color = "red";
    return;
  }

  try {
    await apiPost(`/admin/users/${userId}/group`, {
      groupId: Number(groupId)
    });

    msg.textContent = "ã‚°ãƒ«ãƒ¼ãƒ—ã‚’ç§»å‹•ã—ã¾ã—ãŸã€‚";
    msg.style.color = "green";

    loadGroups();
    loadGroupStats(groupId);

  } catch (e) {
    msg.textContent = "ç§»å‹•ã‚¨ãƒ©ãƒ¼ï¼š" + e;
    msg.style.color = "red";
  }
};


/* -----------------------------
   â–¼ çµ±è¨ˆè¡¨ç¤ºï¼šäººæ•°ãƒ»æ®‹é«˜ãƒ»ãƒã‚¸ã‚·ãƒ§ãƒ³
----------------------------- */
async function loadGroupStats(groupId){
  if (!groupId) return;

  /* 1) å…¨ãƒ¦ãƒ¼ã‚¶ãƒ¼å–å¾— */
  const users = await apiGet("/admin/users");

  /* 2) ã“ã®ã‚°ãƒ«ãƒ¼ãƒ—æ‰€å±ãƒ¦ãƒ¼ã‚¶ãƒ¼ */
  const groupUsers = users.filter(u => Number(u.groupId) === Number(groupId));

  /* 3) åˆè¨ˆæ®‹é«˜ */
  const totalBalance = groupUsers.reduce((s, u)=> s + (u.balanceTotal || 0), 0);

  /* 4) ãƒã‚¸ã‚·ãƒ§ãƒ³ */
  const pos = await apiGet(`/admin/system/positions/${groupId}`);
  const parentCount = pos.parent?.length ?? 0;
  const childCount  = pos.children?.length ?? 0;

/* 5) è¡¨ç¤ºæ›´æ–° */
document.getElementById("stat-user-count").textContent = groupUsers.length;
document.getElementById("stat-total-balance").textContent =
  totalBalance.toLocaleString("en-US") + " JPY";
document.getElementById("stat-positions-count").textContent =
  parentCount + childCount;

/* 6) æ‰€å±ãƒ¦ãƒ¼ã‚¶ãƒ¼ä¸€è¦§ã®æç”» */
const usersTbody = document.getElementById("group-users-body");
usersTbody.innerHTML = "";

/* ã‚°ãƒ«ãƒ¼ãƒ—ã«ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒã„ãªã„å ´åˆ */
if (!groupUsers.length) {
  usersTbody.innerHTML = `
    <tr>
      <td colspan="4" style="text-align:center;">ãƒ¦ãƒ¼ã‚¶ãƒ¼ãªã—</td>
    </tr>`;
  return;
}

/* å­ãƒã‚¸ã‚·ãƒ§ãƒ³ã‚’ userId ã”ã¨ã«é›†è¨ˆï¼ˆã©ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒä½•ãƒã‚¸ã‚·ãƒ§ãƒ³æŒã£ã¦ã„ã‚‹ã‹ï¼‰ */
const posMap = {};
pos.children?.forEach(p => {
  posMap[p.userId] = (posMap[p.userId] || 0) + 1;
});

/* è¡¨ç”Ÿæˆ */
groupUsers.forEach(u => {
  const pc = posMap[u.id] ?? 0; // å­å£åº§ã®ãƒã‚¸ã‚·ãƒ§ãƒ³æ•°

  usersTbody.innerHTML += `
    <tr>
      <td>${u.id}</td>
      <td>${u.name}</td>
      <td>${(u.balanceTotal || 0).toLocaleString("en-US")} JPY</td>
      <td>${pc}</td>
    </tr>
    `;

}); // â† groupUsers.forEach ã®é–‰ã˜

} // â† loadGroupStats() ã®é–‰ã˜


/* =================================================
      â–¼ åˆæœŸãƒ­ãƒ¼ãƒ‰
   ================================================= */
loadGroups();
loadGroupOptions();       // ç§»å‹•å…ˆã‚°ãƒ«ãƒ¼ãƒ—é¸æŠ
loadGroupOptionsStats();  // çµ±è¨ˆç”¨ã‚°ãƒ«ãƒ¼ãƒ—é¸æŠ

/* â–¼ çµ±è¨ˆã‚°ãƒ«ãƒ¼ãƒ—å¤‰æ›´æ™‚ */
document.getElementById("stats-group-select").addEventListener("change", e=>{
  const gid = e.target.value;
  loadGroupStats(gid);
});

/* â–¼ ç§»å‹•ç”¨ã‚°ãƒ«ãƒ¼ãƒ—å¤‰æ›´æ™‚ */
document.getElementById("move-group-select").addEventListener("change", e=>{
  const gid = e.target.value;
  loadGroupStats(gid);
});

</script>

<script src="/admin/assets/js/admin-auth.js"></script>
<script src="/admin/assets/js/header-admin.js"></script>


</body>
</html>
