<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>CryptoX Admin - å‡ºé‡‘ç”³è«‹ç®¡ç†</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <link rel="stylesheet" href="../assets/css/style.css">
  <link rel="stylesheet" href="../assets/css/admin.css">
</head>
<body>

<!-- SIDEBAR -->
<aside class="sidebar">
  <div class="sidebar-title">ãƒ¡ãƒ‹ãƒ¥ãƒ¼</div>
  <ul class="nav-list">
    <li class="nav-item"><a href="index.html" class="nav-link">ğŸ  ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰</a></li>
    <li class="nav-item"><a href="tickets.html" class="nav-link">ğŸ’¬ å•ã„åˆã‚ã›ç®¡ç†</a></li>
    <li class="nav-item"><a href="users.html" class="nav-link">ğŸ‘¥ ãƒ¦ãƒ¼ã‚¶ãƒ¼ä¸€è¦§</a></li>
    <li class="nav-item"><a href="trades.html" class="nav-link">ğŸ“Š å–å¼•çŠ¶æ³</a></li>
    <li class="nav-item"><a href="kyc.html" class="nav-link">ğŸ“‹ KYCçŠ¶æ³</a></li>
    <li class="nav-item"><a href="deposit.html" class="nav-link active">â• å…¥é‡‘ç”³è«‹</a></li>
    <li class="nav-item"><a href="withdraw.html" class="nav-link">â– å‡ºé‡‘ç”³è«‹</a></li>
    <li class="nav-item"><a href="group.html" class="nav-link">ğŸ§© ã‚°ãƒ«ãƒ¼ãƒ—ç®¡ç†</a></li>
    <li class="nav-item"><a href="settings.html" class="nav-link">âš™ï¸ ã‚·ã‚¹ãƒ†ãƒ è¨­å®š</a></li>
    <li class="nav-item"><a href="system-positions.html" class="nav-link">ğŸ“ˆ ã‚·ã‚¹ãƒ†ãƒ ãƒã‚¸ã‚·ãƒ§ãƒ³</a></li>
    <li class="nav-item"><a href="system-history.html" class="nav-link">ğŸ“œ ã‚·ã‚¹ãƒ†ãƒ å±¥æ­´</a></li>
    <li class="nav-item"><a href="deposit-bank-account-edit.html" class="nav-link">ğŸ“œ å…¥é‡‘å£åº§ç®¡ç†</a></li>
  </ul>
</aside>

<!-- HEADER -->
<header class="admin-header">
  <div class="admin-header-left">
    <div class="admin-logo-badge">AX</div>
    <div>
      <div class="admin-logo-text">Admin Console</div>
      <div class="admin-logo-sub">å‡ºé‡‘ç”³è«‹ç®¡ç†</div>
    </div>
  </div>
</header>

<!-- MAIN -->
<main class="admin-main">
  <div class="admin-main-inner">

    <div class="page-title">å‡ºé‡‘ç”³è«‹ä¸€è¦§</div>

    <!-- â–¼ ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ -->
    <div style="margin:12px 0;">
      <select id="status-filter" class="btn-sm">
        <option value="ALL">ã™ã¹ã¦</option>
        <option value="PENDING">ç”³è«‹ä¸­</option>
        <option value="COMPLETED">å®Œäº†</option>
        <option value="CANCELED">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</option>
      </select>
      <button class="btn-sm" id="reload-btn">å†èª­ã¿è¾¼ã¿</button>
    </div>

    <!-- â–¼ TABLE -->
    <div class="card">
      <table class="table" style="width:100%; font-size:13px;">
        <thead>
          <tr>
            <th>ID</th>
            <th>ç”³è«‹æ—¥æ™‚</th>
            <th>åå‰</th>
            <th>ç¨®åˆ¥</th>
            <th>é€šè²¨</th>
            <th>ç”³è«‹é‡‘é¡</th>
            <th>å…¥é‡‘é¡</th>
            <th>æ›´æ–°æ—¥æ™‚</th>
            <th>ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹</th>
            <th>æ“ä½œ</th>
          </tr>
        </thead>
        <tbody id="withdraw-table-body">
          <tr><td colspan="9" style="text-align:center;color:#777;">èª­ã¿è¾¼ã¿ä¸­...</td></tr>
        </tbody>
      </table>
    </div>

  </div>
</main>

<div class="toast" id="toast"></div>

<!-- SCRIPT -->
<script>
const API_BASE = "https://api.exchange-template.com";
let allWithdraws = [];

/* ----------------------
      Utility
---------------------- */
function showToast(msg) {
  const t = document.getElementById("toast");
  t.textContent = msg;
  t.classList.add("show");
  setTimeout(() => t.classList.remove("show"), 2000);
}

function formatDate(s) {
  if (!s) return "-";
  return new Date(s).toLocaleString("ja-JP", { hour12:false });
}

function formatAmount(a) {
  const n = Number(a);
  if (isNaN(n)) return a;
  return n.toLocaleString("en-US", { minimumFractionDigits:2 });
}

/* ----------------------
      API WRAPPER
---------------------- */
async function apiGet(path) {
  const res = await fetch(API_BASE + path, { credentials:"include" });
  const txt = await res.text();
  if (!res.ok) throw new Error(txt);
  return JSON.parse(txt);
}

async function apiPost(path, body) {
  const res = await fetch(API_BASE + path, {
    method:"POST",
    credentials:"include",
    headers:{ "Content-Type": "application/json" },
    body: JSON.stringify(body)
  });
  const txt = await res.text();
  if (!res.ok) throw new Error(txt);
  return JSON.parse(txt);
}

/* ----------------------
      æ‰¿èªãƒ»å–æ¶ˆ
---------------------- */
async function approve(id) {
  try {
    await apiPost("/withdraw/approve", { transferId:id });
    showToast("æ‰¿èªã—ã¾ã—ãŸ");
    loadWithdraws();
  } catch(e) {
    showToast("æ‰¿èªå¤±æ•—");
  }
}

async function cancel(id) {
  try {
    await apiPost("/withdraw/cancel", { transferId:id });
    showToast("ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã—ã¾ã—ãŸ");
    loadWithdraws();
  } catch(e) {
    showToast("ã‚­ãƒ£ãƒ³ã‚»ãƒ«å¤±æ•—");
  }
}

/* ----------------------
      ãƒãƒ£ãƒƒãƒˆé·ç§»
---------------------- */
function openChat(userId) {
  if (!userId) {
    showToast("ãƒ¦ãƒ¼ã‚¶ãƒ¼ä¸æ˜");
    return;
  }
  location.href = `tickets.html?user=${userId}`;
}

/* ----------------------
      TABLE RENDERING
---------------------- */
function renderTable(list) {
  const tbody = document.getElementById("withdraw-table-body");
  tbody.innerHTML = "";

  if (!list.length) {
    tbody.innerHTML =
      `<tr><td colspan="10" style="text-align:center;color:#777;">ç”³è«‹ãªã—</td></tr>`;
    return;
  }

  list.forEach(t => {
    const isCrypto =
      t.cryptoAmount !== null &&
      !isNaN(Number(t.cryptoAmount)) &&
      Number(t.cryptoAmount) > 0;

    const methodLabel = isCrypto ? "æš—å·è³‡ç”£" : "æ—¥æœ¬å††";
    const currency = isCrypto ? t.currency : "JPY";

    const requestAmount = `${formatAmount(t.amount)} JPY`;
    const depositAmount = isCrypto
      ? `${formatAmount(t.cryptoAmount)} ${currency}`
      : `${formatAmount(t.amount)} JPY`;

    const statusJP =
      t.status === "PENDING" ? "ç”³è«‹ä¸­" :
      t.status === "COMPLETED" ? "å®Œäº†" :
      "ã‚­ãƒ£ãƒ³ã‚»ãƒ«";

    tbody.insertAdjacentHTML("beforeend", `
      <tr>
        <td>${t.id}</td>
        <td>${formatDate(t.createdAt)}</td>
        <td>${t.user?.name ?? "-"}</td>
        <td>${methodLabel}</td>
        <td>${currency}</td>
        <td>${requestAmount}</td>
        <td>${depositAmount}</td>
        <td>${formatDate(t.updatedAt)}</td>
        <td>${statusJP}</td>
        <td>
          ${
            t.status === "PENDING"
              ? `<button class="btn-xs btn-xs-primary btn-approve"
                         data-id="${t.id}">æ‰¿èª</button>`
              : ""
          }
          <button class="btn-xs btn-xs-danger btn-cancel"
                  data-id="${t.id}">å–æ¶ˆ</button>
          <button class="btn-xs btn-warning btn-chat"
                  data-user-id="${t.user?.id ?? ""}">ãƒãƒ£ãƒƒãƒˆ</button>
        </td>
      </tr>
    `);
  });

  /* ===== ã“ã“ã§ã‚¤ãƒ™ãƒ³ãƒˆä»˜ä¸ ===== */

  // æ‰¿èª
  tbody.querySelectorAll(".btn-approve").forEach(btn => {
    btn.addEventListener("click", async () => {
      const id = Number(btn.dataset.id);
      await approve(id);
    });
  });

  // å–æ¶ˆ
  tbody.querySelectorAll(".btn-cancel").forEach(btn => {
    btn.addEventListener("click", async () => {
      const id = Number(btn.dataset.id);
      await cancel(id);
    });
  });

  // ãƒãƒ£ãƒƒãƒˆ
  tbody.querySelectorAll(".btn-chat").forEach(btn => {
    btn.addEventListener("click", () => {
      const userId = Number(btn.dataset.userId);
      openChat(userId);
    });
  });
}



  

/* ----------------------
      FILTER APPLY
---------------------- */
function applyFilter() {
  const f = document.getElementById("status-filter").value;
  if (f === "ALL") {
    renderTable(allWithdraws);
  } else {
    renderTable(allWithdraws.filter(t => t.status === f));
  }
}

/* ----------------------
      LOAD WITHDRAWS
---------------------- */
async function loadWithdraws() {
  try {
    allWithdraws = await apiGet("/withdraw/all");
    applyFilter();
  } catch(e) {
    showToast("å–å¾—å¤±æ•—");
  }
}

/* ----------------------
      INIT
---------------------- */
document.getElementById("status-filter").addEventListener("change", applyFilter);
document.getElementById("reload-btn").addEventListener("click", loadWithdraws);

loadWithdraws();
</script>

<script src="/admin/assets/js/admin-auth.js"></script>
<script src="/admin/assets/js/header-admin.js"></script>

</body>
</html>
