<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>CryptoX Exchange - お問い合わせ</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <link rel="stylesheet" href="assets/css/style.css">

  <style>
    /* ===========================
        レイアウト
    ============================ */
    .support-container {
      max-width: 1120px;
      margin: 0 auto;
      padding: 20px;
      display: grid;
      grid-template-columns: 0.9fr 1.4fr;
      gap: 16px;
    }

    @media (max-width: 820px) {
      .support-container {
        grid-template-columns: 1fr;
      }
    }

    .section-card {
      background: #fff;
      padding: 18px;
      border-radius: 12px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.06);
    }

    .section-title {
      font-size: 18px;
      font-weight: bold;
      margin-bottom: 10px;
    }

    /* ===========================
        問い合わせ作成
    ============================ */
    textarea {
      width: 100%;
      min-height: 80px;
      border-radius: 8px;
      border: 1px solid #d1d5db;
      padding: 10px;
      font-size: 14px;
    }

    .form-row {
      margin-bottom: 14px;
    }
    .form-row label {
      font-size: 13px;
      margin-bottom: 4px;
      display: block;
    }

    /* ===========================
        問い合わせ一覧（左）
    ============================ */
    .thread-list {
      margin-top: 12px;
      border-top: 1px solid #e5e7eb;
    }

    .thread-row {
      padding: 12px 6px;
      cursor: pointer;
      border-bottom: 1px solid #eee;
      transition: background 0.15s;
    }
    .thread-row:hover {
      background: #f9fafb;
    }
    .thread-title {
      font-size: 14px;
      font-weight: bold;
    }
    .thread-meta {
      font-size: 11px;
      color: #777;
    }

    /* ===========================
        チャット画面（右）
    ============================ */
    .chat-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding-bottom: 12px;
      border-bottom: 1px solid #e5e7eb;
      margin-bottom: 10px;
    }
    .chat-thread-title {
      font-size: 17px;
      font-weight: bold;
    }

    /* status pill */
    .status-pill {
      padding: 4px 10px;
      font-size: 12px;
      border-radius: 20px;
      background: #e5e7eb;
    }

    .status-OPEN { background:#fde68a; color:#92400e; }
    .status-CLOSED { background:#bbf7d0; color:#065f46; }

    /* chat window */
    .chat-window {
      max-height: 440px;
      overflow-y: auto;
      padding: 10px 4px;
      background: #f8fafc;
      border-radius: 8px;
      border: 1px solid #e5e7eb;
    }

    .chat-msg {
      margin-bottom: 14px;
      padding: 10px 12px;
      border-radius: 10px;
      max-width: 85%;
      line-height: 1.45;
    }
    .chat-msg.user {
      background: #e0f2fe;
      margin-left: auto;
    }
    .chat-msg.admin {
      background: #ede9fe;
      margin-right: auto;
    }

    .chat-meta {
      font-size: 11px;
      margin-bottom: 4px;
      color:#555;
    }

    /* chat input */
    #chat-input-area {
      margin-top: 12px;
      display: flex;
      gap: 10px;
      align-items: flex-start;
    }
    #chat-input {
      flex: 1;
      min-height: 60px;
      font-size: 14px;
      padding: 10px;
      border-radius: 8px;
      border: 1px solid #d1d5db;
    }

    .toast {
      position: fixed;
      bottom: 16px;
      right: 16px;
      background: #333;
      color: #fff;
      padding: 10px 14px;
      border-radius: 6px;
      opacity: 0;
      transition: opacity .3s;
    }
    .toast.show { opacity:1; }
  </style>
</head>

<body>

<!-- HEADER -->
<header class="site-header">
  <div class="logo">
    <div class="logo-badge">CX</div> CryptoX Exchange
  </div>

  <nav class="site-nav">
    <a href="index.html" class="nav-link">TOP</a>
    <a href="exchange.html" class="nav-link">トレード</a>
    <a href="wallet.html" class="nav-link">ウォレット</a>
    <a href="system-trade.html" class="nav-link">システム取引</a>
    <a href="support.html" class="nav-link active">サポート</a>
    <a href="mypage.html" class="nav-link">マイページ</a>
    <a href="kyc.html" class="nav-link">KYC</a>
    <a href="history.html" class="nav-link">取引履歴</a>
  </nav>

  <div class="header-actions">
    <a href="login.html" class="btn btn-outline btn-sm">ログイン</a>
    <a href="signup.html" class="btn btn-primary btn-sm">口座開設</a>
  </div>
</header>

<!-- MAIN -->
<main class="support-container">

  <!-- =======================
        左：スレッド作成 + 一覧
  ======================== -->
  <section class="section-card">
    <h2 class="section-title">お問い合わせを送信</h2>

    <div class="form-row">
      <label>件名</label>
      <input type="text" id="new-title" placeholder="例：入出金についての質問" />
    </div>

    <div class="form-row">
      <label>内容</label>
      <textarea id="new-body" placeholder="できるだけ具体的にご記入ください。"></textarea>
    </div>

    <button class="btn btn-primary btn-sm" id="btn-create-thread">問い合わせを送信</button>

    <hr style="margin:16px 0;" />

    <h3 class="section-title" style="font-size:15px;">あなたの問い合わせ一覧 <span id="thread-count"></span></h3>

    <div id="thread-list" class="thread-list"></div>
  </section>

  <!-- =======================
        右：チャット画面
  ======================== -->
  <section class="section-card">

    <div class="chat-header">
      <div>
        <div id="chat-title" class="chat-thread-title">問い合わせを選択してください</div>
        <div id="chat-sub" style="font-size:12px; color:#777;">左からスレッドを選択</div>
      </div>

      <div class="chat-status">
        <span class="label"></span>
        <span id="chat-status-pill" class="status-pill">-</span>
      </div>
    </div>

    <div class="chat-window" id="chat-window">
      <div class="chat-empty" style="text-align:center; padding:16px; color:#888;">
        スレッドを選択するとメッセージが表示されます。
      </div>
    </div>

    <div id="chat-input-area" style="display:none;">
      <textarea id="chat-input" placeholder="メッセージを入力してください。"></textarea>
      <button class="btn btn-primary btn-sm" id="btn-send-msg">送信</button>
    </div>

  </section>

</main>

<div class="toast" id="toast"></div>

<script>
const API_BASE_URL = "https://api.exchange-template.com";

// DOM
const newTitleEl   = document.getElementById("new-title");
const newBodyEl    = document.getElementById("new-body");
const newSendBtn   = document.getElementById("btn-create-thread");

const threadListEl = document.getElementById("thread-list");
const threadCountEl= document.getElementById("thread-count");

const chatWindowEl = document.getElementById("chat-window");
const chatTitleEl  = document.getElementById("chat-title");
const chatSubEl    = document.getElementById("chat-sub");
const chatStatusEl = document.getElementById("chat-status-pill");

const chatInputArea= document.getElementById("chat-input-area");
const chatInputEl  = document.getElementById("chat-input");
const chatSendBtn  = document.getElementById("btn-send-msg");

let currentTicketId = null;

/* ------------------------------
      API Helpers
------------------------------ */
async function apiGet(path){
  const r = await fetch(API_BASE_URL + path, { credentials:"include" });
  if(!r.ok) throw new Error(await r.text());
  return r.json();
}

async function apiPost(path, body){
  const r = await fetch(API_BASE_URL + path, {
    method:"POST",
    credentials:"include",
    headers:{"Content-Type":"application/json"},
    body: JSON.stringify(body||{})
  });
  const txt = await r.text();
  try { return JSON.parse(txt); } catch { return {}; }
}

/* ------------------------------
      Load Ticket List
------------------------------ */
async function loadTickets(){
  const tickets = await apiGet("/tickets");

  threadListEl.innerHTML = "";
  threadCountEl.textContent = `${tickets.length}件`;

  if(!tickets.length){
    threadListEl.innerHTML =
      '<div style="padding:6px; color:#666;">問い合わせはありません。</div>';
    return;
  }

  tickets.forEach(t => {
    const row = document.createElement("div");
    row.className = "thread-row";
    row.innerHTML = `
      <div class="thread-title">${t.title}</div>
      <div class="thread-meta">ID:${t.id} ／ ${new Date(t.createdAt).toLocaleString("ja-JP")}</div>
    `;
    row.addEventListener("click", () => {
      currentTicketId = t.id;
      loadMessages();
    });
    threadListEl.appendChild(row);
  });
}

/* ------------------------------
      Create Ticket
------------------------------ */
async function createTicket(){
  const title = newTitleEl.value.trim();
  const body  = newBodyEl.value.trim();

  if(!title || !body){
    toast("件名と内容を入力してください");
    return;
  }

  await apiPost("/tickets", { title, message: body });

  newTitleEl.value = "";
  newBodyEl.value  = "";

  toast("お問い合わせを送信しました");
  loadTickets();
}

/* ------------------------------
      Load Messages
------------------------------ */
async function loadMessages(){
  const msgs = await apiGet(`/tickets/${currentTicketId}/messages`);

  chatWindowEl.innerHTML = "";

  msgs.forEach(m => {
    const div = document.createElement("div");
    div.className = "chat-msg " + (m.sender === "ADMIN" ? "admin" : "user");
    div.innerHTML = `
      <div class="chat-meta">
        ${m.sender} ／ ${new Date(m.createdAt).toLocaleString("ja-JP")}
      </div>
      <div class="chat-body">${m.message}</div>
    `;
    chatWindowEl.appendChild(div);
  });

  chatTitleEl.textContent = `スレッド #${currentTicketId}`;
  chatStatusEl.textContent = "-";
  chatSubEl.textContent = "";

  chatInputArea.style.display = "flex";

  chatWindowEl.scrollTop = chatWindowEl.scrollHeight;
}

/* ------------------------------
      Send Message
------------------------------ */
async function sendMessage(){
  const msg = chatInputEl.value.trim();
  if(!msg) return;

  await apiPost(`/tickets/${currentTicketId}/reply`, { message: msg });
  chatInputEl.value = "";

  loadMessages();
}

/* ------------------------------
      Toast
------------------------------ */
function toast(msg){
  const t = document.getElementById("toast");
  t.textContent = msg;
  t.classList.add("show");
  setTimeout(()=> t.classList.remove("show"), 1700);
}

/* ------------------------------
      Init
------------------------------ */
newSendBtn.addEventListener("click", createTicket);
chatSendBtn.addEventListener("click", sendMessage);

loadTickets();

const API_BASE = "https://api.exchange-template.com";

async function updateHeaderUserState() {
  const loginBtn = document.querySelector(".header-actions a[href='login.html']");
  const signupBtn = document.querySelector(".header-actions a[href='signup.html']");

  if (!loginBtn || !signupBtn) return;

  try {
    const res = await fetch(API_BASE + "/auth/me", { credentials: "include" });
    if (!res.ok) return; // 未ログインなら何もしない

    const data = await res.json();
    const user = data.user || data;

    // 既存ボタンをクリア
    const headerActions = document.querySelector(".header-actions");
    headerActions.innerHTML = "";

    // マイページボタン
    const mp = document.createElement("a");
    mp.href = "mypage.html";
    mp.className = "btn btn-outline btn-sm";
    mp.textContent = user.name + " さん";
    headerActions.appendChild(mp);

    // ログアウトボタン
    const lo = document.createElement("a");
    lo.href = "#";
    lo.className = "btn btn-primary btn-sm";
    lo.textContent = "ログアウト";
    lo.addEventListener("click", async () => {
      await fetch(API_BASE + "/auth/logout", {
        method: "POST",
        credentials: "include"
      });
      location.href = "login.html";
    });
    headerActions.appendChild(lo);

  } catch (e) {
    console.warn("Not logged in");
  }
}

// ページ読込後に実行
document.addEventListener("DOMContentLoaded", updateHeaderUserState);

</script>

</body>
</html>
