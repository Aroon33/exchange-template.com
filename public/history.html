<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>CryptoX Exchange - 取引履歴</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <link rel="stylesheet" href="assets/css/style.css">

  <style>
    /* ============================
        カード・レイアウト
    ============================ */
    .section-card {
      background: #fff;
      padding: 20px;
      border-radius: 12px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.06);
      max-width: 980px;
      margin: 24px auto;
    }

    h1.card-title {
      font-size: 22px;
      margin-bottom: 6px;
    }
    h2.section-title {
      font-size: 18px;
      margin-bottom: 10px;
      margin-top: 20px;
      font-weight: bold;
    }

    /* ============================
        テーブル
    ============================ */
    .table-wrapper {
      overflow-x: auto;
    }

    table.table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 10px;
      font-size: 14px;
    }

    table.table th {
      background: #f1f5f9;
      text-align: left;
      padding: 10px;
      border-bottom: 2px solid #e5e7eb;
      white-space: nowrap;
    }
    table.table td {
      padding: 10px;
      border-bottom: 1px solid #e5e7eb;
      white-space: nowrap;
    }

    tr:hover {
      background: #f8fafc;
    }

    .profit {
      color: #059669;
      font-weight: bold;
    }
    .loss {
      color: #dc2626;
      font-weight: bold;
    }

    /* ============================
        続きを見るボタン
    ============================ */
    #btn-loadmore {
      margin-top: 14px;
      padding: 8px 16px;
      font-size: 14px;
    }

    @media (max-width: 600px) {
      table.table th, table.table td {
        padding: 7px;
        font-size: 12px;
      }
    }
  </style>
</head>

<body>

<!-- HEADER -->
<header class="site-header">
  <div class="logo">
    <div class="logo-badge">CX</div>
    CryptoX Exchange
  </div>

  <nav class="site-nav">
    <a href="index.html" class="nav-link">TOP</a>
    <a href="exchange.html" class="nav-link">トレード</a>
    <a href="wallet.html" class="nav-link">ウォレット</a>
    <a href="system-trade.html" class="nav-link">システム取引</a>
    <a href="support.html" class="nav-link">サポート</a>
    <a href="mypage.html" class="nav-link">マイページ</a>
    <a href="kyc.html" class="nav-link">KYC</a>
    <a href="history.html" class="nav-link active">取引履歴</a>
  </nav>

  <div class="header-actions">
    <a href="login.html" class="btn btn-outline btn-sm">ログイン</a>
    <a href="signup.html" class="btn btn-primary btn-sm">口座開設</a>
  </div>
</header>

<main>
  <section class="section-card">
    <h1 class="card-title">取引履歴</h1>
    <p class="muted">決済済みの取引履歴を確認できます。</p>
    <p id="history-message" class="muted" style="margin-bottom: 16px;"></p>

    <!-- 取引履歴 -->
    <h2 class="section-title">トレード履歴</h2>

    <div class="table-wrapper">
      <table class="table">
        <thead>
          <tr>
            <th>ID</th>
            <th>銘柄</th>
            <th>売買</th>
            <th>数量</th>
            <th>建値</th>
            <th>決済値</th>
            <th>損益</th>
            <th>決済日時</th>
          </tr>
        </thead>
        <tbody id="trade-history-body">
          <tr>
            <td colspan="8" style="text-align:center; color:#888;">
              取引履歴はありません。
            </td>
          </tr>
        </tbody>
      </table>
    </div>

    <div style="text-align:center;">
      <button id="btn-loadmore" class="btn btn-outline btn-sm" style="display:none;">
        続きを見る
      </button>
    </div>

  </section>
</main>

<script>
const API_BASE_URL = "https://api.exchange-template.com";

const elMsg       = document.getElementById("history-message");
const elTradeBody = document.getElementById("trade-history-body");
const btnLoadMore = document.getElementById("btn-loadmore");

let trades = [];
let displayCount = 20;     // 最初に表示する件数
const LOAD_COUNT  = 20;    // ボタンで増やす件数

async function apiGet(path){
  const res = await fetch(API_BASE_URL + path, { credentials:"include" });
  if(!res.ok) throw new Error(await res.text());
  return res.json();
}

function fmtDate(iso){
  if(!iso) return "-";
  return new Date(iso).toLocaleString("ja-JP",{ hour12:false });
}

function fmtNum(n){
  if(n == null) return "-";
  return Number(n).toLocaleString("en-US",{ minimumFractionDigits:2 });
}

/* -------------------------
      履歴描画
-------------------------- */
function renderTrades(){
  elTradeBody.innerHTML = "";

  if(!trades.length){
    elTradeBody.innerHTML =
    `<tr><td colspan="8" style="text-align:center; color:#888;">取引履歴はありません。</td></tr>`;
    btnLoadMore.style.display = "none";
    return;
  }

  const slice = trades.slice(0, displayCount);

  slice.forEach(t=>{
    const profitClass = Number(t.profit) >= 0 ? "profit" : "loss";

    elTradeBody.innerHTML += `
      <tr>
        <td>${t.id}</td>
        <td>${t.symbol}</td>
        <td>${t.side}</td>
        <td>${fmtNum(t.size)}</td>
        <td>${fmtNum(t.entryPrice)}</td>
        <td>${fmtNum(t.closePrice)}</td>
        <td class="${profitClass}">${fmtNum(t.profit)}</td>
        <td>${fmtDate(t.closedAt)}</td>
      </tr>
    `;
  });

  // ボタン制御
  if(displayCount >= trades.length){
    btnLoadMore.style.display = "none";
  } else {
    btnLoadMore.style.display = "inline-block";
  }
}

/* -------------------------
      追加読み込み
-------------------------- */
function loadMore(){
  displayCount += LOAD_COUNT;
  renderTrades();
}

/* -------------------------
      初期ロード
-------------------------- */
(async function init(){
  try {
    trades = await apiGet("/trades/history");

    elMsg.textContent = "取引履歴を更新しました。";
    elMsg.style.color = "green";

    renderTrades();

  } catch (e){
    console.error(e);
    elMsg.textContent = "取引履歴の取得に失敗しました。";
    elMsg.style.color = "red";
  }
})();

// イベント
btnLoadMore.addEventListener("click", loadMore);

const API_BASE = "https://api.exchange-template.com";

async function updateHeaderUserState() {
  const loginBtn = document.querySelector(".header-actions a[href='login.html']");
  const signupBtn = document.querySelector(".header-actions a[href='signup.html']");

  if (!loginBtn || !signupBtn) return;

  try {
    const res = await fetch(API_BASE + "/auth/me", { credentials: "include" });
    if (!res.ok) return; // 未ログインなら何もしない

    const data = await res.json();
    const user = data.user || data;

    // 既存ボタンをクリア
    const headerActions = document.querySelector(".header-actions");
    headerActions.innerHTML = "";

    // マイページボタン
    const mp = document.createElement("a");
    mp.href = "mypage.html";
    mp.className = "btn btn-outline btn-sm";
    mp.textContent = user.name + " さん";
    headerActions.appendChild(mp);

    // ログアウトボタン
    const lo = document.createElement("a");
    lo.href = "#";
    lo.className = "btn btn-primary btn-sm";
    lo.textContent = "ログアウト";
    lo.addEventListener("click", async () => {
      await fetch(API_BASE + "/auth/logout", {
        method: "POST",
        credentials: "include"
      });
      location.href = "login.html";
    });
    headerActions.appendChild(lo);

  } catch (e) {
    console.warn("Not logged in");
  }
}

// ページ読込後に実行
document.addEventListener("DOMContentLoaded", updateHeaderUserState);
</script>

</body>
</html>
