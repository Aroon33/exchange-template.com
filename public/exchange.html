<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>CryptoX Exchange - ãƒˆãƒ¬ãƒ¼ãƒ‰ç”»é¢</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <!-- TradingView -->
  <script src="https://s3.tradingview.com/tv.js"></script>

  <!-- å¤–éƒ¨å…±é€š CSS -->
  <link rel="stylesheet" href="assets/css/style.css">

  <!-- è¿½åŠ ãƒˆãƒ¬ãƒ¼ãƒ‰ãƒšãƒ¼ã‚¸å°‚ç”¨ CSS -->
  <style>
    /* ===========================
       ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆ
    ============================ */
    .exchange-grid {
      display: grid;
      grid-template-columns: 260px 1fr 320px;
      gap: 14px;
      padding: 16px;
    }

    @media (max-width: 900px) {
      .exchange-grid {
        grid-template-columns: 1fr;
      }
    }

    /* ===========================
       ãƒãƒ¼ã‚±ãƒƒãƒˆãƒªã‚¹ãƒˆ
    ============================ */
    #market-list {
      display: flex;
      flex-direction: column;
      gap: 6px;
      max-height: 520px;
      overflow-y: auto;
    }

    .market-item {
      display: flex;
      justify-content: space-between;
      padding: 10px;
      border-radius: 8px;
      border: 1px solid var(--border-soft);
      background: #fff;
      cursor: pointer;
      transition: 0.2s;
    }

    .market-item.active {
      background: var(--primary-light);
      border-color: var(--primary);
    }
    .market-item:hover { background: #f5f7fa; }

    @media(max-width:900px) {
      #market-list {
        display: flex;
        flex-direction: row;
        overflow-x: auto;
        gap: 10px;
        padding-bottom: 8px;
      }
      .market-item {
        min-width: 140px;
      }
    }

    /* ===========================
       ãƒãƒ£ãƒ¼ãƒˆ
    ============================ */
    #tv_chart {
      width: 100%;
      height: 420px;
      border-radius: 8px;
      overflow: hidden;
    }

    /* ===========================
       æ³¨æ–‡æ¿ / ç´„å®š
    ============================ */
    .orderbook-list,
    .recent-trades {
      max-height: 240px;
      overflow-y: auto;
      padding-right: 4px;
    }

    .orderbook-row {
      display: flex;
      justify-content: space-between;
      padding: 4px 2px;
      font-size: 13px;
    }
    .orderbook-row.sell { color: #dc2626; }
    .orderbook-row.buy  { color: #059669; }

    .trade-row {
      display: flex;
      justify-content: space-between;
      padding: 4px 2px;
      font-size: 13px;
    }

    /* ã‚¹ãƒãƒ›ã§ã¯æŠ˜ã‚ŠãŸãŸã¿ */
    .collapse-toggle {
      cursor: pointer;
      font-size: 14px;
      padding: 6px;
      background: #f3f4f6;
      border-radius: 6px;
      margin-bottom: 8px;
    }
    .collapse-content {
      display: none;
    }

    @media(min-width:901px) {
      .collapse-toggle { display:none; }
      .collapse-content { display:block !important; }
    }

    /* ===========================
       æ³¨æ–‡ãƒ‘ãƒãƒ«
    ============================ */
    .order-panel select,
    .order-panel input {
      width: 100%;
      padding: 8px;
      margin: 6px 0;
      border: 1px solid var(--border-soft);
      border-radius: 6px;
    }

    .order-btn-buy {
      background: var(--success);
      color: #fff;
      width: 100%;
      padding: 10px;
      border-radius: 6px;
      margin-top: 6px;
    }
    .order-btn-sell {
      background: var(--danger);
      color: #fff;
      width: 100%;
      padding: 10px;
      border-radius: 6px;
      margin-top: 6px;
    }

    .order-note {
      font-size: 11px;
      margin-top: 6px;
      color: var(--text-muted);
    }

  </style>
</head>

<body>

<header class="site-header">
  <div class="logo">
    <div class="logo-badge">CX</div>
    CryptoX Exchange
  </div>
  
  <nav class="site-nav">
    <a href="index.html" class="nav-link">TOP</a>
    <a href="exchange.html" class="nav-link active">ãƒˆãƒ¬ãƒ¼ãƒ‰</a>
    <a href="wallet.html" class="nav-link">ã‚¦ã‚©ãƒ¬ãƒƒãƒˆ</a>
    <a href="system-trade.html" class="nav-link">ã‚·ã‚¹ãƒ†ãƒ å–å¼•</a>
    <a href="support.html" class="nav-link">ã‚µãƒãƒ¼ãƒˆ</a>
    <a href="mypage.html" class="nav-link">ãƒã‚¤ãƒšãƒ¼ã‚¸</a>
  </nav>

  <div class="header-actions">
    <a href="login.html" class="btn btn-outline btn-sm">ãƒ­ã‚°ã‚¤ãƒ³</a>
    <a href="signup.html" class="btn btn-primary btn-sm">å£åº§é–‹è¨­</a>
  </div>
</header>



<!-- ===========================
      MAIN LAYOUT
=========================== -->

<main class="exchange-grid">

  <!-- ========== MARKET LIST ========== -->
  <section class="card">
    <div class="card-header">
      <div class="card-title">ãƒãƒ¼ã‚±ãƒƒãƒˆ</div>
    </div>
    <div id="market-list"></div>
  </section>

  <!-- ========== CHART AREA ========== -->
  <section class="chart-area">
    <div class="chart-header">
      <div>
        <div id="chartSymbolMain" class="chart-main-symbol">BTC / USD</div>
        <div id="chartSymbolSub" class="chart-sub-symbol">Bitcoin Â· ç¾ç‰©</div>
      </div>
    </div>

    <div id="tv_chart"></div>
  </section>

  <!-- ========== ORDER SIDE ========== -->
  <section class="order-side">

    <!-- æŠ˜ã‚ŠãŸãŸã¿ï¼šæ³¨æ–‡æ¿ -->
    <div class="collapse-toggle" onclick="toggleCollapse('orderbookWrap')">ğŸ“‰ æ³¨æ–‡æ¿ï¼ˆã‚¿ãƒƒãƒ—ã§é–‹é–‰ï¼‰</div>
    <div id="orderbookWrap" class="collapse-content">
      <div class="card">
        <div class="card-header"><div class="card-title">æ³¨æ–‡æ¿</div></div>
        <div class="orderbook-list" id="orderbook"></div>
      </div>
    </div>

    <!-- æ³¨æ–‡ãƒ‘ãƒãƒ« -->
    <div class="card order-panel">
      <div class="card-header">
        <div class="card-title">æ³¨æ–‡</div>
      </div>

      <select id="order-type">
        <option value="market">æˆè¡Œæ³¨æ–‡</option>
        <option value="limit">æŒ‡å€¤æ³¨æ–‡</option>
      </select>

      <input type="number" id="order-price" placeholder="ä¾¡æ ¼ (æŒ‡å€¤æ™‚)" disabled>
      <input type="number" id="order-amount" placeholder="æ•°é‡">

      <button class="order-btn-buy">è²·ã„</button>
      <button class="order-btn-sell">å£²ã‚Š</button>

      <div class="order-note">
        â€» ãƒ‡ãƒ¢ç‰ˆã®ãŸã‚å®Ÿéš›ã«ã¯æ³¨æ–‡ãƒ»ç´„å®šã•ã‚Œã¾ã›ã‚“ã€‚
      </div>
    </div>

    <!-- æŠ˜ã‚ŠãŸãŸã¿ï¼šæœ€æ–°ç´„å®š -->
    <div class="collapse-toggle" onclick="toggleCollapse('recentWrap')">ğŸ“ˆ æœ€æ–°ã®ç´„å®šï¼ˆã‚¿ãƒƒãƒ—ã§é–‹é–‰ï¼‰</div>
    <div id="recentWrap" class="collapse-content">
      <div class="card">
        <div class="card-header"><div class="card-title">æœ€æ–°ã®ç´„å®š</div></div>
        <div class="recent-trades" id="recent-trades"></div>
      </div>
    </div>

  </section>

</main>




<script>
/* ===========================
      ãƒãƒ¼ã‚±ãƒƒãƒˆä¸€è¦§
=========================== */
const markets = [
  { symbol: "BTC/USD", tv: "BINANCE:BTCUSDT", name: "Bitcoin", price: 67420 },
  { symbol: "ETH/USD", tv: "BINANCE:ETHUSDT", name: "Ethereum", price: 3120 },
  { symbol: "SOL/USD", tv: "BINANCE:SOLUSDT", name: "Solana", price: 178 },
  { symbol: "DOGE/USD", tv: "BINANCE:DOGEUSDT", name: "Dogecoin", price: 0.18 },
  { symbol: "XRP/USD", tv: "BINANCE:XRPUSDT", name: "XRP", price: 0.55 },
  { symbol: "ADA/USD", tv: "BINANCE:ADAUSDT", name: "Cardano", price: 0.42 }
];

let currentMarket = markets[0];

function renderMarketList() {
  const list = document.getElementById("market-list");
  list.innerHTML = "";

  markets.forEach(m => {
    const item = document.createElement("div");
    item.className = "market-item" + (m.symbol === currentMarket.symbol ? " active" : "");
    item.innerHTML = `
      <div>
        <div class="market-symbol">${m.symbol}</div>
        <div class="market-name">${m.name}</div>
      </div>
      <div>${m.price}</div>
    `;

    item.addEventListener("click", () => {
      currentMarket = m;
      updateMarketInfo();
      renderMarketList();
      initTradingView(m.tv);
      generateOrderbook();
      generateTrades();
    });

    list.appendChild(item);
  });
}

function updateMarketInfo() {
  document.getElementById("chartSymbolMain").textContent =
    currentMarket.symbol.replace("/", " / ");
  document
    .getElementById("chartSymbolSub")
    .textContent = `${currentMarket.name} Â· ç¾ç‰©`;
}

/* ===========================
      TradingView
=========================== */
function initTradingView(symbol) {
  document.getElementById("tv_chart").innerHTML = "";

  new TradingView.widget({
    container_id: "tv_chart",
    symbol: symbol || "BINANCE:BTCUSDT",
    interval: "15",
    timezone: "Asia/Tokyo",
    theme: "light",
    style: "1",
    locale: "ja",
    autosize: true,
  });
}

/* ===========================
      æ³¨æ–‡æ¿
=========================== */
function generateOrderbook() {
  const el = document.getElementById("orderbook");
  el.innerHTML = "";
  for (let i = 0; i < 12; i++) {
    const price = (currentMarket.price + (Math.random() - 0.5) * 40).toFixed(2);
    const amount = (Math.random() * 2).toFixed(3);
    const row = document.createElement("div");
    row.className = "orderbook-row " + (i < 6 ? "sell" : "buy");
    row.innerHTML = `<span>${price}</span><span>${amount}</span>`;
    el.appendChild(row);
  }
}

/* ===========================
      æœ€æ–°ç´„å®š
=========================== */
function generateTrades() {
  const el = document.getElementById("recent-trades");
  el.innerHTML = "";
  for (let i = 0; i < 14; i++) {
    const price = (currentMarket.price + (Math.random() - 0.5) * 40).toFixed(2);
    const amount = (Math.random() * 2).toFixed(3);
    const buy = Math.random() > 0.5;
    const row = document.createElement("div");
    row.className = "trade-row";
    row.style.color = buy ? "var(--success)" : "var(--danger)";
    row.innerHTML = `<span>${price}</span><span>${amount}</span>`;
    el.appendChild(row);
  }
}

/* ===========================
      æŠ˜ã‚ŠãŸãŸã¿ï¼ˆã‚¹ãƒãƒ›ï¼‰
=========================== */
function toggleCollapse(id){
  const box = document.getElementById(id);
  box.style.display = box.style.display === "block" ? "none" : "block";
}

/* ===========================
      INIT
=========================== */
document.addEventListener("DOMContentLoaded", () => {
  renderMarketList();
  updateMarketInfo();
  initTradingView(currentMarket.tv);
  generateOrderbook();
  generateTrades();
});

/* ===========================
      æ³¨æ–‡ã‚¿ã‚¤ãƒ—åˆ‡æ›¿
=========================== */
document.getElementById("order-type").addEventListener("change", e => {
  document.getElementById("order-price").disabled = e.target.value === "market";
});

/* ===========================
      ãƒ˜ãƒƒãƒ€ãƒ¼ã®ãƒ­ã‚°ã‚¤ãƒ³åˆ‡æ›¿
=========================== */
const API_BASE = "https://api.exchange-template.com";

async function updateHeaderUserState() {
  const headerActions = document.querySelector(".header-actions");
  if (!headerActions) return;

  try {
    const res = await fetch(API_BASE + "/auth/me", { credentials:"include" });
    if (!res.ok) return;

    const data = await res.json();
    const user = data.user || data;

    headerActions.innerHTML = `
      <a href="mypage.html" class="btn btn-outline btn-sm">${user.name} ã•ã‚“</a>
      <a href="#" id="logoutBtn" class="btn btn-primary btn-sm">ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ</a>
    `;

    document.getElementById("logoutBtn").addEventListener("click", async () => {
      await fetch(API_BASE + "/auth/logout",{method:"POST",credentials:"include"});
      location.href = "login.html";
    });

  } catch(e) {}
}
document.addEventListener("DOMContentLoaded", updateHeaderUserState);
</script>

</body>
</html>
