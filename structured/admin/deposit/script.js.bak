const API_BASE = "https://api.exchange-template.com";

/* =========================
   Utils
========================= */
function showToast(msg) {
  const t = document.getElementById("toast");
  t.textContent = msg;
  t.classList.add("show");
  setTimeout(() => t.classList.remove("show"), 2000);
}

function formatDate(v) {
  return v ? new Date(v).toLocaleString("ja-JP", { hour12:false }) : "-";
}

function formatAmount(v, type="JPY") {
  const n = Number(v);
  if (isNaN(n)) return "-";
  return type === "CRYPTO" ? n.toFixed(4) : Math.floor(n).toLocaleString("ja-JP");
}

/* =========================
   API
========================= */
async function apiGet(path) {
  const r = await fetch(API_BASE + path, { credentials:"include" });
  if (!r.ok) throw new Error();
  return r.json();
}

async function apiPost(path, body) {
  const r = await fetch(API_BASE + path, {
    method:"POST",
    credentials:"include",
    headers:{ "Content-Type":"application/json" },
    body: JSON.stringify(body),
  });
  if (!r.ok) throw new Error();
}

/* =========================
   Actions
========================= */
async function approveDeposit(id) {
  await apiPost("/deposit/approve", { id });
  showToast("æ‰¿èªã—ã¾ã—ãŸ");
  loadDeposits();
}

async function sendDepositAddress(id) {
  if (!confirm("å…¥é‡‘ã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’é€ä¿¡ã—ã¾ã™ã‹ï¼Ÿ")) return;
  await apiPost("/deposit/assign-crypto", { id });
  showToast("å…¥é‡‘ã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’é€ä¿¡ã—ã¾ã—ãŸ");
  loadDeposits();
}

function openChat(userId) {
  location.href = `tickets.html?user=${userId}`;
}

/* =========================
   Modal
========================= */
function openDepositModal(t) {
  document.getElementById("modal-body").innerHTML = `
    <div>IDï¼š${t.id}</div>
    <div>ãƒ¦ãƒ¼ã‚¶ãƒ¼ï¼š${t.user?.name ?? "-"}</div>
    <div>é€šè²¨ï¼š${t.currency}</div>
    <div>é‡‘é¡ï¼š${t.cryptoAmount ?? t.amount}</div>
    <div>çŠ¶æ…‹ï¼š${t.status}</div>
    <div>${formatDate(t.createdAt)}</div>
  `;

  document.getElementById("modal-footer").innerHTML = `
    ${t.status==="PENDING" && t.method==="CRYPTO"
      ? `<button class="btn" onclick="sendDepositAddress(${t.id})">ã‚¢ãƒ‰ãƒ¬ã‚¹é€ä¿¡</button>` : ""}
    ${t.status==="CONFIRMING"
      ? `<button class="btn" onclick="approveDeposit(${t.id})">ç€é‡‘ç¢ºèª</button>` : ""}
    <button class="btn" onclick="openChat(${t.user?.id})">ãƒãƒ£ãƒƒãƒˆ</button>
  `;

  document.getElementById("deposit-modal").style.display="block";
}

function closeDepositModal() {
  document.getElementById("deposit-modal").style.display="none";
}

/* =========================
   Render
========================= */
function renderTable(list) {
  const tbody = document.getElementById("deposit-table-body");
  tbody.innerHTML = "";

  if (!list.length) {
    tbody.innerHTML = `<tr><td colspan="100%" style="text-align:center;">ç”³è«‹ãªã—</td></tr>`;
    return;
  }

  list.forEach(t => {
    const isCrypto = t.cryptoAmount && Number(t.cryptoAmount) > 0;
    const currency = isCrypto ? t.currency : "JPY";
    const amount = isCrypto
      ? `${formatAmount(t.cryptoAmount,"CRYPTO")} ${currency}`
      : `${formatAmount(t.amount)} JPY`;

    tbody.insertAdjacentHTML("beforeend", `
<tr class="deposit-row"
    onclick="if(window.innerWidth<=900){openDepositModal(${JSON.stringify(t)})}"
    style="cursor:pointer;">

  <td>
    <div>ID:${t.id}</div>
    <div>${t.user?.name ?? "-"}</div>
    <div>${currency}</div>
    <div>${amount}</div>
    <div>${t.status}</div>
  </td>

  <td class="pc-only">${formatDate(t.createdAt)}</td>
  <td class="pc-only">${t.user?.name ?? "-"}</td>
  <td class="pc-only">${t.method}</td>
  <td class="pc-only">${currency}</td>
  <td class="pc-only">${formatAmount(t.amount)} JPY</td>
  <td class="pc-only">${amount}</td>
  <td class="pc-only">${formatDate(t.updatedAt)}</td>
  <td class="pc-only">${t.status}</td>

  <td class="actions pc-only">
    ${t.status==="PENDING" && t.method==="CRYPTO"
      ? `<button onclick="event.stopPropagation();sendDepositAddress(${t.id})">é€ä¿¡</button>` : ""}
    ${t.status==="CONFIRMING"
      ? `<button onclick="event.stopPropagation();approveDeposit(${t.id})">ç¢ºèª</button>` : ""}
    <button onclick="event.stopPropagation();openChat(${t.user?.id})">ğŸ’¬</button>
  </td>
</tr>
`);
  });
}

/* =========================
   Load
========================= */
async function loadDeposits() {
  const status = document.getElementById("status-filter").value;
  let list = await apiGet("/deposit/all");
  if (status === "PENDING") list = await apiGet("/deposit/pending");
  else if (status !== "ALL") list = list.filter(t=>t.status===status);
  renderTable(list);
}

document.getElementById("status-filter").addEventListener("change", loadDeposits);
document.getElementById("reload-btn").addEventListener("click", loadDeposits);
loadDeposits().catch(console.error);
